# 容器镜像仓库配置指南

## 一、容器镜像仓库选择

### 你已经有的配置

从 `tencent-ccr-secret.yaml` 可以看出，你已经配置了**腾讯云容器镜像服务（CCR）**：
- 仓库地址：`ccr.ccs.tencentyun.com`
- 账号：`57455363`

**建议：继续使用腾讯云 CCR**，因为你已经配置好了。

---

## 二、主流容器镜像仓库对比

| 仓库 | 地址 | 优点 | 缺点 | 价格 |
|------|------|------|------|------|
| **腾讯云 CCR** | ccr.ccs.tencentyun.com | 国内访问快、稳定 | 需要腾讯云账号 | 个人版免费 |
| **阿里云 ACR** | registry.cn-hangzhou.aliyuncs.com | 国内访问快、功能丰富 | 需要阿里云账号 | 个人版免费 |
| **Docker Hub** | docker.io | 全球最大、公开镜像多 | 国内访问慢、限流 | 免费版有限制 |
| **Harbor** | 自建 | 完全控制、私有化 | 需要维护 | 服务器成本 |

### 推荐方案

1. **继续使用腾讯云 CCR**（推荐）
   - 你已经配置好了
   - 国内访问速度快
   - 与你的 RKE2 集群在同一云平台（如果在腾讯云）

2. **如果需要阿里云**
   - 适合已有阿里云账号的情况
   - 配置方式类似

---

## 三、腾讯云容器镜像服务配置

### 1. 登录腾讯云控制台

访问：https://console.cloud.tencent.com/tcr

### 2. 创建命名空间

在容器镜像服务中创建命名空间，例如：
- `nms4cloud` - 用于存放你的 Java 项目镜像
- `jenkins` - 用于存放 Jenkins 相关镜像

### 3. 创建镜像仓库

为每个微服务创建镜像仓库，例如：
- `nms4cloud/pos1starter`
- `nms4cloud/pos2plugin`
- `nms4cloud/pos3boot`
- 等等...

### 4. 获取访问凭证

在"访问凭证"页面获取：
- 用户名（通常是你的腾讯云账号 ID）
- 密码（需要重置或创建）

---

## 四、Jenkins 配置推送镜像

### 1. 在 Jenkins 中配置 Docker 凭证

访问 Jenkins：`Manage Jenkins` → `Credentials` → `System` → `Global credentials`

添加凭证：
- **Kind**: Username with password
- **Username**: `57455363`（你的腾讯云账号 ID）
- **Password**: `你的 CCR 密码`
- **ID**: `tencent-ccr-credentials`
- **Description**: 腾讯云容器镜像服务凭证

### 2. 确保 Jenkins 可以使用 Docker

有两种方式：

#### 方式 A：挂载宿主机 Docker（推荐）

修改 `jenkins-deployment.yaml`：

```yaml
spec:
  containers:
    - name: jenkins
      image: jenkins/jenkins:lts-jdk21
      volumeMounts:
        - name: jenkins-storage
          mountPath: /var/jenkins_home
        - name: docker-sock
          mountPath: /var/run/docker.sock
        - name: docker-bin
          mountPath: /usr/bin/docker
  volumes:
    - name: jenkins-storage
      persistentVolumeClaim:
        claimName: jenkins-pvc
    - name: docker-sock
      hostPath:
        path: /var/run/docker.sock
    - name: docker-bin
      hostPath:
        path: /usr/bin/docker
```

#### 方式 B：使用 DinD（Docker in Docker）

使用包含 Docker 的 Jenkins 镜像：

```dockerfile
FROM jenkins/jenkins:lts-jdk21

USER root

# 安装 Docker CLI
RUN apt-get update && apt-get install -y \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

RUN curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

RUN echo \
  "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian \
  $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

RUN apt-get update && apt-get install -y docker-ce-cli

USER jenkins
```

---

## 五、更新 Jenkinsfile 添加 Docker 构建和推送

在 Jenkinsfile 中添加 Docker 构建和推送阶段：

```groovy
environment {
    // ... 现有配置 ...

    // Docker 配置
    DOCKER_REGISTRY = 'ccr.ccs.tencentyun.com'
    DOCKER_NAMESPACE = 'nms4cloud'
    DOCKER_CREDENTIAL_ID = 'tencent-ccr-credentials'
}

stages {
    // ... 现有 stages ...

    stage('构建 Docker 镜像') {
        steps {
            script {
                echo "=== 构建 Docker 镜像 ==="

                def moduleName = params.BUILD_MODULE
                def imageName = "${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/${moduleName}"
                def imageTag = "${env.BUILD_NUMBER}"

                // 构建镜像
                sh """
                    docker build -t ${imageName}:${imageTag} \
                        -t ${imageName}:latest \
                        -f Dockerfile \
                        --build-arg JAR_FILE=artifacts/${moduleName}*.jar \
                        .
                """

                // 保存镜像信息供后续使用
                env.DOCKER_IMAGE = "${imageName}:${imageTag}"
            }
        }
    }

    stage('推送 Docker 镜像') {
        steps {
            script {
                echo "=== 推送 Docker 镜像到腾讯云 CCR ==="

                // 使用 Jenkins 凭证登录
                docker.withRegistry("https://${DOCKER_REGISTRY}", "${DOCKER_CREDENTIAL_ID}") {
                    sh """
                        docker push ${env.DOCKER_IMAGE}
                        docker push ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/${params.BUILD_MODULE}:latest
                    """
                }
            }
        }
    }

    stage('清理本地镜像') {
        steps {
            script {
                echo "=== 清理本地 Docker 镜像 ==="
                sh """
                    docker rmi ${env.DOCKER_IMAGE} || true
                    docker rmi ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/${params.BUILD_MODULE}:latest || true
                """
            }
        }
    }
}
```

---

## 六、创建 Dockerfile

在项目根目录创建 `Dockerfile`：

```dockerfile
FROM openjdk:21-jdk-slim

# 设置工作目录
WORKDIR /app

# 复制 jar 文件
ARG JAR_FILE
COPY ${JAR_FILE} app.jar

# 暴露端口（根据实际情况修改）
EXPOSE 8080

# 启动应用
ENTRYPOINT ["java", "-jar", "/app/app.jar"]

# 可选：添加 JVM 参数
# ENTRYPOINT ["java", "-Xmx512m", "-Xms256m", "-jar", "/app/app.jar"]
```

---

## 七、在 Kubernetes 中使用镜像

### 1. 确保 Secret 已创建

```bash
# 检查 secret 是否存在
kubectl get secret tencent-ccr-secret -n nms4cloud

# 如果不存在，创建
kubectl apply -f tencent-ccr-secret.yaml
```

### 2. 在 Deployment 中引用镜像

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pos1starter
  namespace: nms4cloud
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pos1starter
  template:
    metadata:
      labels:
        app: pos1starter
    spec:
      # 引用镜像拉取凭证
      imagePullSecrets:
        - name: tencent-ccr-secret
      containers:
        - name: pos1starter
          # 使用腾讯云 CCR 的镜像
          image: ccr.ccs.tencentyun.com/nms4cloud/pos1starter:latest
          ports:
            - containerPort: 8080
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: "prod"
```

---

## 八、完整的 CI/CD 流程

```
1. 开发提交代码到 Git
   ↓
2. Jenkins 自动触发构建
   ↓
3. Maven 编译打包 JAR
   ↓
4. Docker 构建镜像
   ↓
5. 推送镜像到腾讯云 CCR
   ↓
6. 更新 Kubernetes Deployment
   ↓
7. Kubernetes 拉取新镜像并部署
```

---

## 九、常见问题

### 1. Jenkins 无法连接 Docker

**问题**：`Cannot connect to the Docker daemon`

**解决**：
```bash
# 检查 Docker socket 权限
ls -la /var/run/docker.sock

# 给 Jenkins 用户添加 Docker 权限
kubectl exec -it -n jenkins <jenkins-pod> -- chmod 666 /var/run/docker.sock
```

### 2. 推送镜像失败

**问题**：`unauthorized: authentication required`

**解决**：
- 检查 Jenkins 凭证是否正确
- 检查腾讯云 CCR 密码是否过期
- 重新创建访问凭证

### 3. Kubernetes 拉取镜像失败

**问题**：`ImagePullBackOff`

**解决**：
```bash
# 检查 secret 是否存在
kubectl get secret tencent-ccr-secret -n nms4cloud

# 检查 secret 内容是否正确
kubectl get secret tencent-ccr-secret -n nms4cloud -o yaml

# 重新创建 secret
kubectl delete secret tencent-ccr-secret -n nms4cloud
kubectl apply -f tencent-ccr-secret.yaml
```

---

## 十、如果要使用阿里云 ACR

如果你想使用阿里云容器镜像服务：

### 1. 登录阿里云控制台

访问：https://cr.console.aliyun.com/

### 2. 创建命名空间和仓库

与腾讯云类似的操作

### 3. 创建 Secret

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: aliyun-acr-secret
  namespace: nms4cloud
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: <base64-encoded-docker-config>
```

### 4. 修改 Jenkinsfile

```groovy
environment {
    DOCKER_REGISTRY = 'registry.cn-hangzhou.aliyuncs.com'
    DOCKER_NAMESPACE = 'your-namespace'
    DOCKER_CREDENTIAL_ID = 'aliyun-acr-credentials'
}
```

---

## 总结

**推荐方案**：
1. 继续使用腾讯云 CCR（你已经配置好了）
2. 在 Jenkins 中添加 Docker 构建和推送阶段
3. 使用方式 A（挂载宿主机 Docker）更简单稳定

需要我帮你更新 Jenkinsfile 或创建 Dockerfile 吗？
