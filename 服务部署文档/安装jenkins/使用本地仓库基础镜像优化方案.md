# 使用本地仓库基础镜像优化 Docker 构建速度

## 🎯 优化目标

- 加快基础镜像拉取速度（从本地仓库拉取）
- 减少推送到阿里云的数据量（利用镜像分层）
- 提高构建稳定性（不依赖外网）

## 📋 方案概述

### 当前流程
```
Kaniko 拉取 eclipse-temurin:21-jre (Docker Hub) → 慢
构建应用镜像
推送到阿里云个人仓库 → 慢
```

### 优化后流程
```
Kaniko 拉取 eclipse-temurin:21-jre (本地仓库) → 快 ✅
构建应用镜像
推送到阿里云个人仓库（只推送变更层）→ 快 ✅
```

---

## 🚀 实施步骤

### 步骤 1：将基础镜像推送到本地仓库

假设你的本地仓库地址是：`192.168.80.100:5000`

```bash
# 1. 拉取官方基础镜像
docker pull eclipse-temurin:21-jre

# 2. 标记为本地仓库镜像
docker tag eclipse-temurin:21-jre 192.168.80.100:5000/library/eclipse-temurin:21-jre

# 3. 推送到本地仓库
docker push 192.168.80.100:5000/library/eclipse-temurin:21-jre

# 4. 验证
docker pull 192.168.80.100:5000/library/eclipse-temurin:21-jre
```

### 步骤 2：修改 Dockerfile

**原 Dockerfile：**
```dockerfile
FROM eclipse-temurin:21-jre

COPY target/*.jar app.jar
COPY src/main/resources/*   config/
ENTRYPOINT ["java","-jar","/app.jar"]
```

**优化后 Dockerfile：**
```dockerfile
# 使用本地仓库的基础镜像
FROM 192.168.80.100:5000/library/eclipse-temurin:21-jre

COPY target/*.jar app.jar
COPY src/main/resources/*   config/
ENTRYPOINT ["java","-jar","/app.jar"]
```

### 步骤 3：配置 Kaniko 使用本地仓库

**方法 A：直接在 Dockerfile 中指定（推荐）**

已经在步骤 2 中完成。

**方法 B：使用 Kaniko 的 --insecure-registry 参数**

如果本地仓库是 HTTP（非 HTTPS），需要添加：

```groovy
/kaniko/executor \
    --context=${buildContext} \
    --dockerfile=${dockerfilePath} \
    --destination=${dockerImageName}:${DOCKER_IMAGE_TAG} \
    --insecure-registry=192.168.80.100:5000 \
    ...
```

### 步骤 4：配置 Kubernetes 信任本地仓库

**如果本地仓库是 HTTP（非 HTTPS），需要配置：**

```bash
# 在每个节点上配置
# RKE2 配置文件：/etc/rancher/rke2/registries.yaml

cat > /etc/rancher/rke2/registries.yaml <<EOF
mirrors:
  "192.168.80.100:5000":
    endpoint:
      - "http://192.168.80.100:5000"
configs:
  "192.168.80.100:5000":
    tls:
      insecure_skip_verify: true
EOF

# 重启 RKE2
systemctl restart rke2-server  # 或 rke2-agent
```

---

## 📊 性能对比

### 首次构建（基础镜像未缓存）

| 步骤 | 使用 Docker Hub | 使用本地仓库 | 节省时间 |
|------|----------------|-------------|---------|
| 拉取基础镜像 | 3-5 分钟 | 10 秒 | **3-5 分钟** ✅ |
| 构建应用镜像 | 1 分钟 | 1 分钟 | - |
| 推送到阿里云 | 8 分钟 | 8 分钟 | - |
| **总计** | **12-14 分钟** | **9-10 分钟** | **3-4 分钟** ✅ |

### 后续构建（只修改代码）

| 步骤 | 使用 Docker Hub | 使用本地仓库 | 节省时间 |
|------|----------------|-------------|---------|
| 拉取基础镜像 | 0 秒（缓存） | 10 秒 | - |
| 构建应用镜像 | 1 分钟 | 1 分钟 | - |
| 推送到阿里云 | 2 分钟（只推送变更层）✅ | 2 分钟（只推送变更层）✅ | - |
| **总计** | **3 分钟** | **3 分钟** | **差不多** |

---

## 🎯 关键优化点

### 1. Docker 镜像分层机制 ⭐

**镜像结构：**
```
应用镜像
├─ Layer 1: 基础镜像 (220 MB) ← 来自 eclipse-temurin:21-jre
├─ Layer 2: JAR 文件 (50 MB)  ← 你的应用
└─ Layer 3: 配置文件 (1 MB)   ← 配置
```

**推送机制：**
- 第一次推送：推送所有层（271 MB）
- 后续推送：只推送变更的层（51 MB）✅
- **这是最大的优化！**

### 2. 基础镜像缓存

**Kaniko 缓存机制：**
- Kaniko 会缓存已拉取的基础镜像
- 后续构建会使用缓存（如果基础镜像未变）
- 但首次构建仍需拉取

**使用本地仓库的优势：**
- 首次构建快
- 不依赖外网
- 稳定可靠

---

## 🔧 完整配置示例

### 1. 修改所有模块的 Dockerfile

```bash
# 批量修改所有 Dockerfile
find E:\nms4cloud\nms4cloud-app -name "Dockerfile" -type f -exec sed -i 's|FROM eclipse-temurin:21-jre|FROM 192.168.80.100:5000/library/eclipse-temurin:21-jre|g' {} \;
```

### 2. 更新 Jenkinsfile（如果需要）

```groovy
// 如果本地仓库是 HTTP，添加 --insecure-registry
/kaniko/executor \
    --context=${buildContext} \
    --dockerfile=${dockerfilePath} \
    --destination=${dockerImageName}:${DOCKER_IMAGE_TAG} \
    --destination=${dockerImageName}:latest \
    --insecure-registry=192.168.80.100:5000 \
    --compression=gzip \
    --compression-level=9 \
    --push-retry=3 \
    --cache=false \
    --verbosity=info
```

---

## ⚠️ 注意事项

### 1. 本地仓库地址

确保 Kaniko Pod 可以访问本地仓库：

```bash
# 在 Kaniko Pod 中测试
kubectl exec -it <kaniko-pod> -n jenkins -- /busybox/sh
wget http://192.168.80.100:5000/v2/_catalog
```

### 2. HTTPS vs HTTP

**如果本地仓库使用 HTTPS：**
- 不需要 `--insecure-registry`
- 需要配置 CA 证书

**如果本地仓库使用 HTTP：**
- 需要 `--insecure-registry`
- 需要配置 RKE2 信任该仓库

### 3. 镜像同步

定期同步官方基础镜像到本地仓库：

```bash
# 每月同步一次
docker pull eclipse-temurin:21-jre
docker tag eclipse-temurin:21-jre 192.168.80.100:5000/library/eclipse-temurin:21-jre
docker push 192.168.80.100:5000/library/eclipse-temurin:21-jre
```

---

## 🎉 总结

### 优化效果

1. ✅ **首次构建快 3-5 分钟**（基础镜像从本地仓库拉取）
2. ✅ **后续构建稳定**（不依赖外网）
3. ✅ **推送到阿里云自动优化**（只推送变更层）

### 最佳实践

1. ✅ 将常用基础镜像推送到本地仓库
2. ✅ 在 Dockerfile 中使用本地仓库镜像
3. ✅ 配置 RKE2 信任本地仓库
4. ✅ 定期同步官方镜像

### 下一步

1. 确认本地仓库地址
2. 推送基础镜像到本地仓库
3. 修改 Dockerfile
4. 测试构建

开始优化吧！🚀
