# Jenkins + Kubernetes + Kaniko 完整配置总结

## 当前状态：✅ 配置文件已完成

所有必要的配置文件和文档都已创建完成，现在需要在 Jenkins 中进行实际配置。

## 一、已完成的工作

### 1. Docker Registry + Web UI
- ✅ 创建了 `registry-with-proxy.yaml`
- ✅ Registry API: `192.168.80.100:30500`
- ✅ Web UI: 通过同一端口访问
- ✅ 配置了 CORS 和 Nginx 反向代理

### 2. Spring Boot 示例项目
- ✅ 完整的项目结构（pom.xml + 源代码）
- ✅ 简化的单阶段 Dockerfile
- ✅ REST API 端点和健康检查

### 3. Jenkins 流水线文件
- ✅ `Jenkinsfile-simple`: 基础 Maven 构建
- ✅ `Jenkinsfile-local`: 本地代码构建
- ✅ `Jenkinsfile-git`: Git + Maven 缓存
- ✅ `Jenkinsfile-k8s`: Kubernetes + Kaniko（推荐使用）

### 4. 完整文档
- ✅ Kubernetes Cloud 配置步骤图解
- ✅ 为什么需要 Kubernetes Cloud
- ✅ Kaniko 与 Kubernetes Cloud 的关系
- ✅ Jenkins Kubernetes Plugin 安装步骤
- ✅ 流水线设计模式说明

## 二、核心概念理解

### Kubernetes Cloud 和 Kaniko 的关系

```
┌─────────────────────────────────────────┐
│      Kubernetes Cloud                   │  ← 必须配置！
│  (Jenkins 连接 K8s 的桥梁)              │
│                                          │
│  作用：                                  │
│  1. 连接 K8s 集群                       │
│  2. 创建 Pod                            │
│  3. 管理 Pod 生命周期                   │
└─────────────────────────────────────────┘
              ↓ 创建
┌─────────────────────────────────────────┐
│              Pod                         │
│  ┌─────────────────────────────────┐   │
│  │  Maven 容器                      │   │
│  │  - 构建 JAR                      │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │  Kaniko 容器                     │   │  ← Kaniko 在这里工作
│  │  - 构建镜像                      │   │
│  │  - 推送镜像                      │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

**重要：** 使用 Kaniko 仍然需要 Kubernetes Cloud！
- ✅ Kaniko 替代了 Docker daemon
- ❌ Kaniko 不能替代 Kubernetes Cloud
- ✅ 两者配合使用才能完成构建

## 三、接下来需要做的事情

### 步骤 1：安装 Kubernetes Plugin

```
1. 登录 Jenkins: http://<节点IP>:30080
2. 系统管理 → 插件管理
3. 可选插件 → 搜索 "Kubernetes"
4. 勾选 "Kubernetes" → 点击 "安装"
5. 等待安装完成
```

### 步骤 2：配置 Kubernetes Cloud

```
1. 系统管理 → 节点管理 → Configure Clouds
2. Add a new cloud → Kubernetes
3. 填写配置：
   - 名称: kubernetes
   - Kubernetes 地址: https://kubernetes.default.svc.cluster.local
   - 命名空间: jenkins
   - Jenkins 地址: http://jenkins.jenkins.svc.cluster.local:8080
4. 点击 "Test Connection"
5. 看到 "✓ Connection test successful" 后点击 "Save"
```

**详细步骤请参考：** `Kubernetes-Cloud配置步骤图解.md`

### 步骤 3：创建必要的 Kubernetes 资源

#### 3.1 创建 Maven 缓存 PVC

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: jenkins-maven-cache
  namespace: jenkins
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 10Gi
EOF
```

#### 3.2 创建 Docker 配置 ConfigMap

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: ConfigMap
metadata:
  name: docker-config
  namespace: jenkins
data:
  config.json: |
    {
      "insecure-registries": ["192.168.80.100:30500"]
    }
EOF
```

### 步骤 4：在 Jenkins 中创建流水线

```
1. Jenkins 首页 → 新建任务
2. 输入任务名称: demo-springboot
3. 选择 "流水线" → 确定
4. 配置：
   - 流水线定义: Pipeline script from SCM
   - SCM: Git
   - Repository URL: https://codeup.aliyun.com/613895a803e1c17d57a7630f/mytest.git
   - Credentials: aliyun-codeup-token
   - 分支: */master
   - Script Path: Jenkinsfile-k8s
5. 保存
```

### 步骤 5：执行构建

```
1. 进入 demo-springboot 任务
2. 点击 "Build with Parameters"
3. 配置参数：
   - GIT_BRANCH: master
   - SKIP_TESTS: true
   - CLEAN_BUILD: true
   - BUILD_DOCKER_IMAGE: true
4. 点击 "开始构建"
```

### 步骤 6：验证构建

#### 6.1 查看构建日志

```
构建过程中应该看到：
✓ 创建 Pod
✓ Maven 构建 JAR
✓ Kaniko 构建镜像
✓ 推送镜像到私有仓库
✓ 删除 Pod
```

#### 6.2 查看 Pod 创建

```bash
# 在构建过程中执行
kubectl get pods -n jenkins

# 应该看到类似：
NAME                                READY   STATUS    RESTARTS   AGE
demo-springboot-1-xxxxx-xxxxx       2/2     Running   0          30s
```

#### 6.3 验证镜像推送

```bash
# 查看私有仓库中的镜像
curl http://192.168.80.100:30500/v2/_catalog

# 应该看到：
{
  "repositories": ["demo-springboot"]
}

# 查看镜像标签
curl http://192.168.80.100:30500/v2/demo-springboot/tags/list

# 应该看到：
{
  "name": "demo-springboot",
  "tags": ["1", "latest"]
}
```

## 四、配置清单

### 必须完成的配置

```
☐ 1. 安装 Kubernetes Plugin
☐ 2. 配置 Kubernetes Cloud
     ├─ Kubernetes 地址
     ├─ 命名空间
     └─ Jenkins 地址
☐ 3. 创建 Maven 缓存 PVC
☐ 4. 创建 Docker 配置 ConfigMap
☐ 5. 创建 Jenkins 流水线任务
☐ 6. 执行第一次构建
☐ 7. 验证镜像推送成功
```

## 五、常见问题排查

### 问题 1：Invalid agent type "kubernetes"

**原因：** 没有安装 Kubernetes Plugin

**解决：** 按照步骤 1 安装插件

### 问题 2：Test Connection 失败

**原因：** ServiceAccount 权限不足

**解决：**
```bash
kubectl create clusterrolebinding jenkins \
  --clusterrole=cluster-admin \
  --serviceaccount=jenkins:jenkins
```

### 问题 3：Pod 创建失败

**原因：** PVC 或 ConfigMap 不存在

**解决：** 按照步骤 3 创建资源

### 问题 4：Kaniko 推送镜像失败

**原因：** Docker 配置不正确

**解决：** 检查 ConfigMap 中的 insecure-registries 配置

## 六、文件位置

### 配置文件
```
服务部署文档/安装jenkins/
├── registry-with-proxy.yaml              # Docker Registry + UI
├── demo-springboot/
│   ├── Jenkinsfile-k8s                   # 主要流水线文件
│   ├── Dockerfile                        # 简化的 Dockerfile
│   ├── pom.xml                           # Maven 配置
│   └── src/                              # 源代码
└── 文档/
    ├── Kubernetes-Cloud配置步骤图解.md
    ├── 为什么需要Kubernetes-Cloud.md
    ├── Kaniko与Kubernetes-Cloud的关系.md
    └── Jenkins-Kubernetes-Plugin安装步骤.md
```

### 关键文件说明

| 文件 | 用途 |
|------|------|
| `Jenkinsfile-k8s` | 主要流水线文件，使用 Kubernetes + Kaniko |
| `Dockerfile` | 单阶段 Dockerfile，复制已构建的 JAR |
| `Kubernetes-Cloud配置步骤图解.md` | 详细的配置步骤 |
| `Kaniko与Kubernetes-Cloud的关系.md` | 解释为什么两者都需要 |

## 七、架构图

### 完整构建流程

```
用户触发构建
    ↓
Jenkins Master
    ↓
查找 Kubernetes Cloud 配置
    ↓
连接 RKE2 集群
    ↓
创建构建 Pod
    ├── Maven 容器
    │   ├── 拉取代码
    │   ├── 下载依赖（缓存到 PVC）
    │   └── 构建 JAR
    └── Kaniko 容器
        ├── 读取 Dockerfile
        ├── 构建镜像
        └── 推送到私有仓库 (192.168.80.100:30500)
    ↓
删除 Pod
    ↓
构建完成
```

## 八、下一步优化建议

### 1. 添加代码质量检查
```groovy
stage('代码质量检查') {
    steps {
        container('maven') {
            sh 'mvn sonar:sonar'
        }
    }
}
```

### 2. 添加安全扫描
```groovy
stage('安全扫描') {
    steps {
        container('trivy') {
            sh 'trivy image ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}'
        }
    }
}
```

### 3. 自动部署到 K8s
```groovy
stage('部署到 K8s') {
    steps {
        container('kubectl') {
            sh '''
                kubectl set image deployment/demo-springboot \
                  demo-springboot=${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} \
                  -n default
            '''
        }
    }
}
```

## 九、总结

### 已完成
- ✅ 所有配置文件已创建
- ✅ 所有文档已编写
- ✅ 流水线已优化

### 待完成
- ⏳ 在 Jenkins 中安装 Kubernetes Plugin
- ⏳ 配置 Kubernetes Cloud
- ⏳ 创建 K8s 资源（PVC、ConfigMap）
- ⏳ 执行第一次构建

### 关键点
1. **Kubernetes Cloud 是必须的** - 即使使用 Kaniko
2. **Dockerfile 已简化** - 只复制已构建的 JAR
3. **流水线已优化** - Maven + Kaniko 两个容器
4. **文档已完善** - 每个步骤都有详细说明

**现在可以按照上面的步骤在 Jenkins 中进行配置了！**
