# 精确的镜像构建和推送时间统计

## 改进说明

现在使用**两步操作**来精确测量构建时间和推送时间：

### 第1步：构建镜像（不推送）
```bash
BUILD_START=$(date +%s)

/kaniko/executor \
    --no-push \                    # 不推送，只构建
    --tar-path=/tmp/image.tar \    # 保存为tar文件
    ...

BUILD_END=$(date +%s)
BUILD_DURATION=$((BUILD_END - BUILD_START))
```

### 第2步：推送镜像到Harbor
```bash
PUSH_START=$(date +%s)

/kaniko/executor \
    --destination=harbor... \      # 推送到Harbor
    ...

PUSH_END=$(date +%s)
PUSH_DURATION=$((PUSH_END - PUSH_START))
```

---

## 输出示例

```bash
>>> 预估镜像大小
  JAR文件: 45 MB
  基础镜像: 220 MB
  预估总大小: 265 MB

>>> [1/2] 开始构建镜像...
[Kaniko 构建输出...]
✓ 镜像构建完成 (耗时: 2分15秒)
  实际镜像大小: 258 MB

>>> [2/2] 开始推送镜像到Harbor...
[Kaniko 推送输出...]
✓ 镜像推送完成 (耗时: 1分10秒)

════════════════════════════════════════
镜像构建和推送统计
════════════════════════════════════════
模块名称: nms4cloud-platform
镜像大小: 258 MB
构建时间: 2分15秒 (135秒)
推送时间: 1分10秒 (70秒)
总耗时:   3分25秒 (205秒)
推送速度: 29 Mbps
压缩级别: Level 9 (最高)
重试次数: 最多3次
超时设置: 1800秒 (30分钟)
════════════════════════════════════════

✓ 镜像已推送到Harbor:
  harbor-core.harbor/library/nms4cloud-platform:123
  harbor-core.harbor/library/nms4cloud-platform:latest
```

---

## 时间统计说明

### 1. 构建时间（精确）
**包含内容：**
- 拉取基础镜像（eclipse-temurin:21-jre）
- 复制JAR文件和配置文件
- 构建镜像层
- 压缩镜像（Level 9）
- 保存为tar文件

**不包含：**
- 网络推送时间
- Harbor处理时间

### 2. 推送时间（精确）
**包含内容：**
- 重新构建镜像（Kaniko会使用缓存，很快）
- 网络传输到Harbor
- Harbor接收和存储
- 重试机制（如果失败）

**不包含：**
- 初次镜像构建时间

### 3. 实际镜像大小
**获取方式：**
- 从第1步生成的tar文件获取
- 这是压缩后的实际大小
- 比预估更准确

### 4. 推送速度（精确）
**计算公式：**
```bash
推送速度 (Mbps) = 实际镜像大小 (MB) × 8 / 推送时间 (秒)
```

**说明：**
- 使用实际镜像大小（不是预估）
- 只计算推送时间（不包含构建）
- 真实反映网络推送速度

---

## 性能分析

### 典型时间分布

**小型镜像（< 200MB）：**
- 构建时间: 1-2分钟
- 推送时间: 30-60秒
- 总耗时: 2-3分钟

**中型镜像（200-400MB）：**
- 构建时间: 2-3分钟
- 推送时间: 1-2分钟
- 总耗时: 3-5分钟

**大型镜像（> 400MB）：**
- 构建时间: 3-5分钟
- 推送时间: 2-4分钟
- 总耗时: 5-9分钟

### 推送速度参考

**本地Harbor（同集群）：**
- **优秀**: > 50 Mbps
- **良好**: 30-50 Mbps
- **正常**: 20-30 Mbps
- **较慢**: 10-20 Mbps
- **很慢**: < 10 Mbps

---

## 优化建议

### 如果构建时间过长

1. **增加Kaniko容器CPU**
   ```yaml
   resources:
     limits:
       cpu: 8000m  # 增加到8核
   ```

2. **降低压缩级别**
   ```bash
   --compression-level=6  # 从9降到6
   ```

3. **启用缓存**
   ```bash
   --cache=true
   --cache-repo=harbor-core.harbor/cache
   ```

### 如果推送时间过长

1. **检查网络带宽**
   ```bash
   # 测试到Harbor的网络速度
   kubectl exec -it <pod> -- iperf3 -c harbor-core.harbor
   ```

2. **检查Harbor性能**
   ```bash
   # 查看Harbor资源使用
   kubectl top pods -n harbor
   ```

3. **增加Harbor存储性能**
   - 使用SSD存储
   - 增加IOPS配额

---

## 为什么要分两步？

### 优点

1. **✅ 精确测量**
   - 构建时间和推送时间完全分离
   - 不需要推算或估计

2. **✅ 真实镜像大小**
   - 从tar文件获取实际大小
   - 不是预估值

3. **✅ 准确的推送速度**
   - 只计算网络传输时间
   - 真实反映网络性能

4. **✅ 便于性能分析**
   - 可以单独优化构建或推送
   - 快速定位瓶颈

### 缺点

1. **❌ 总时间略长**
   - 需要构建两次（第二次很快，有缓存）
   - 增加约10-20秒

2. **❌ 占用临时空间**
   - 需要保存tar文件
   - 构建完成后会自动清理

---

## 对比：之前 vs 现在

### 之前（一步操作）
```bash
总耗时: 3分25秒
推送速度: ~10 Mbps (推算，不准确)
```
- ❌ 无法区分构建和推送时间
- ❌ 推送速度是推算的
- ❌ 镜像大小是预估的

### 现在（两步操作）
```bash
构建时间: 2分15秒 (精确)
推送时间: 1分10秒 (精确)
总耗时:   3分25秒
推送速度: 29 Mbps (精确)
镜像大小: 258 MB (实际)
```
- ✅ 构建和推送时间分离
- ✅ 推送速度是实际测量的
- ✅ 镜像大小是实际的

---

## 故障排查

### 问题1: 第1步构建失败

**错误信息：**
```
error building image: ...
```

**解决：**
- 检查Dockerfile语法
- 验证JAR文件存在
- 查看Kaniko详细日志

### 问题2: 第2步推送失败

**错误信息：**
```
error pushing image: ...
```

**解决：**
- 检查Harbor认证
- 验证网络连接
- 查看Harbor日志

### 问题3: tar文件过大

**错误信息：**
```
No space left on device
```

**解决：**
- 增加Kaniko容器临时存储
- 清理旧的tar文件
- 优化镜像大小

---

## 相关文件

- `Jenkinsfile-nms4cloud-final` - 主项目（已更新）
- `Jenkinsfile-nms4cloud-pos-java-optimized-v2` - POS项目（已更新）

两个文件都已经更新为两步操作，提供精确的时间统计。
