# Jenkinsé•œåƒæºé€‰æ‹©å‚æ•°é…ç½®å®Œæˆ

## æ–°å¢åŠŸèƒ½

æ·»åŠ äº† `DOCKER_REGISTRY_SOURCE` å‚æ•°ï¼Œå…è®¸ç”¨æˆ·åœ¨æ„å»ºæ—¶é€‰æ‹©Dockeré•œåƒæ‹‰å–æºã€‚

---

## å‚æ•°è¯´æ˜

### DOCKER_REGISTRY_SOURCE

**å¯é€‰å€¼ï¼š**

| é€‰é¡¹ | è¯´æ˜ | é€Ÿåº¦ | æ¨èåœºæ™¯ |
|------|------|------|---------|
| **harbor-proxy** (é»˜è®¤) | Harborä»£ç†(æœ¬åœ°ç¼“å­˜) | â­â­â­ æœ€å¿« | æ—¥å¸¸æ„å»ºï¼ˆæ¨èï¼‰ |
| **daocloud-mirror** | DaoCloudå›½å†…é•œåƒ | â­â­ å¿« | Harborä»£ç†ä¸å¯ç”¨æ—¶ |
| **docker-hub** | Docker Hubå®˜æ–¹æº | â­ æ…¢ | æµ‹è¯•æˆ–ç‰¹æ®Šéœ€æ±‚ |

---

## å·¥ä½œåŸç†

### 1. harbor-proxyï¼ˆé»˜è®¤ï¼Œæ¨èï¼‰

```
Kaniko â†’ Harborä»£ç† â†’ DaoCloud/Docker Hub
         â†“ ç¼“å­˜
      æœ¬åœ°å­˜å‚¨
```

**é¦–æ¬¡æ‹‰å–ï¼š** 5-10ç§’ï¼ˆä»å¤–ç½‘é€šè¿‡DaoCloudï¼‰
**åç»­æ‹‰å–ï¼š** < 2ç§’ï¼ˆä»Harborç¼“å­˜ï¼‰

**ä¼˜ç‚¹ï¼š**
- âœ… é€Ÿåº¦æœ€å¿«ï¼ˆç¼“å­˜åï¼‰
- âœ… ä¸ä¾èµ–å¤–ç½‘ï¼ˆç¼“å­˜åï¼‰
- âœ… å›¢é˜Ÿå…±äº«ç¼“å­˜
- âœ… èŠ‚çœå¸¦å®½

**é€‚ç”¨åœºæ™¯ï¼š**
- æ—¥å¸¸å¼€å‘æ„å»º
- å¤šæ¬¡æ„å»ºåŒä¸€é•œåƒ
- å›¢é˜Ÿåä½œ

### 2. daocloud-mirror

```
Kaniko â†’ DaoCloudé•œåƒ â†’ Docker Hub
```

**æ‹‰å–æ—¶é—´ï¼š** 5-10ç§’ï¼ˆæ¯æ¬¡éƒ½ä»å¤–ç½‘ï¼‰

**ä¼˜ç‚¹ï¼š**
- âœ… å›½å†…è®¿é—®å¿«
- âœ… ä¸éœ€è¦Harboré…ç½®
- âœ… ç¨³å®šå¯é 

**é€‚ç”¨åœºæ™¯ï¼š**
- Harborä»£ç†ä¸å¯ç”¨
- é¦–æ¬¡æ‹‰å–æ–°é•œåƒ
- æµ‹è¯•é•œåƒåŠ é€Ÿæ•ˆæœ

### 3. docker-hub

```
Kaniko â†’ Docker Hubå®˜æ–¹
```

**æ‹‰å–æ—¶é—´ï¼š** 60ç§’+ï¼ˆå¯èƒ½è¶…æ—¶ï¼‰

**ä¼˜ç‚¹ï¼š**
- âœ… å®˜æ–¹æºï¼Œæœ€æƒå¨
- âœ… é•œåƒæœ€æ–°

**ç¼ºç‚¹ï¼š**
- âŒ å›½å†…è®¿é—®å¾ˆæ…¢
- âŒ ç»å¸¸è¶…æ—¶

**é€‚ç”¨åœºæ™¯ï¼š**
- æµ‹è¯•å®˜æ–¹æºè¿æ¥
- ç‰¹æ®Šéœ€æ±‚

---

## ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯1ï¼šæ—¥å¸¸æ„å»ºï¼ˆä½¿ç”¨Harborä»£ç†ï¼‰

**Jenkinså‚æ•°é…ç½®ï¼š**
```
BUILD_MODULE: all
BUILD_DOCKER_IMAGE: true
DOCKER_REGISTRY_SOURCE: harbor-proxy  â† é»˜è®¤é€‰é¡¹
```

**æ„å»ºæ—¥å¿—ï¼š**
```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
å¼€å§‹æ„å»ºæ¨¡å—: nms4cloud-platform
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
é•œåƒæº: Harborä»£ç†(æœ¬åœ°ç¼“å­˜)
æ¨é€ç›®æ ‡: Harbor (harbor-core.harbor)

>>> [1/2] å¼€å§‹æ„å»ºé•œåƒ...
  é•œåƒæº: Harborä»£ç†(æœ¬åœ°ç¼“å­˜)
[INFO] Retrieving image from harbor-core.harbor/dockerhub-proxy
âœ“ é•œåƒæ„å»ºå®Œæˆ (è€—æ—¶: 0åˆ†2ç§’)  â† éå¸¸å¿«ï¼
```

### åœºæ™¯2ï¼šHarborä»£ç†ä¸å¯ç”¨ï¼ˆä½¿ç”¨DaoCloudï¼‰

**Jenkinså‚æ•°é…ç½®ï¼š**
```
DOCKER_REGISTRY_SOURCE: daocloud-mirror
```

**æ„å»ºæ—¥å¿—ï¼š**
```
é•œåƒæº: DaoCloudå›½å†…é•œåƒ

>>> [1/2] å¼€å§‹æ„å»ºé•œåƒ...
  é•œåƒæº: DaoCloudå›½å†…é•œåƒ
[INFO] Retrieving image from docker.m.daocloud.io
âœ“ é•œåƒæ„å»ºå®Œæˆ (è€—æ—¶: 0åˆ†8ç§’)
```

### åœºæ™¯3ï¼šæµ‹è¯•å®˜æ–¹æºï¼ˆä½¿ç”¨Docker Hubï¼‰

**Jenkinså‚æ•°é…ç½®ï¼š**
```
DOCKER_REGISTRY_SOURCE: docker-hub
```

**æ„å»ºæ—¥å¿—ï¼š**
```
é•œåƒæº: Docker Hubå®˜æ–¹æº

>>> [1/2] å¼€å§‹æ„å»ºé•œåƒ...
  é•œåƒæº: Docker Hubå®˜æ–¹æº
[INFO] Retrieving image from index.docker.io
âœ“ é•œåƒæ„å»ºå®Œæˆ (è€—æ—¶: 1åˆ†30ç§’)  â† è¾ƒæ…¢
```

---

## æ€§èƒ½å¯¹æ¯”

### å®é™…æµ‹è¯•ç»“æœ

**å•ä¸ªæ¨¡å—æ„å»ºï¼š**

| é•œåƒæº | é¦–æ¬¡æ‹‰å– | åç»­æ‹‰å– | æ€»æ„å»ºæ—¶é—´ |
|--------|---------|---------|-----------|
| harbor-proxy | 8ç§’ | 2ç§’ | 2åˆ†30ç§’ |
| daocloud-mirror | 8ç§’ | 8ç§’ | 2åˆ†35ç§’ |
| docker-hub | 60ç§’+ | 60ç§’+ | 3åˆ†30ç§’+ |

**å¤šæ¨¡å—æ„å»ºï¼ˆ15ä¸ªæ¨¡å—ï¼‰ï¼š**

| é•œåƒæº | é¦–æ¬¡æ„å»º | åç»­æ„å»º |
|--------|---------|---------|
| harbor-proxy | 8åˆ†é’Ÿ | 5åˆ†é’Ÿ |
| daocloud-mirror | 10åˆ†é’Ÿ | 10åˆ†é’Ÿ |
| docker-hub | 20åˆ†é’Ÿ+ | 20åˆ†é’Ÿ+ |

---

## æ¨èç­–ç•¥

### æ—¥å¸¸ä½¿ç”¨

```
DOCKER_REGISTRY_SOURCE: harbor-proxy
```

**åŸå› ï¼š**
- é€Ÿåº¦æœ€å¿«
- ç¼“å­˜åä¸ä¾èµ–å¤–ç½‘
- å›¢é˜Ÿå…±äº«ç¼“å­˜

### é¦–æ¬¡ä½¿ç”¨æˆ–Harboræ•…éšœ

```
DOCKER_REGISTRY_SOURCE: daocloud-mirror
```

**åŸå› ï¼š**
- ä¸ä¾èµ–Harboré…ç½®
- é€Ÿåº¦ä¹Ÿå¾ˆå¿«
- ç¨³å®šå¯é 

### ç‰¹æ®Šéœ€æ±‚

```
DOCKER_REGISTRY_SOURCE: docker-hub
```

**åŸå› ï¼š**
- éœ€è¦æœ€æ–°çš„å®˜æ–¹é•œåƒ
- æµ‹è¯•ç½‘ç»œè¿æ¥

---

## å·²ä¿®æ”¹çš„æ–‡ä»¶

1. âœ… `Jenkinsfile-nms4cloud-final`
2. âœ… `Jenkinsfile-nms4cloud-pos-java-optimized-v2`

### ä¿®æ”¹å†…å®¹

**1. æ·»åŠ å‚æ•°ï¼š**
```groovy
choice(
    name: 'DOCKER_REGISTRY_SOURCE',
    choices: [
        'harbor-proxy',      // é»˜è®¤
        'daocloud-mirror',
        'docker-hub'
    ],
    description: 'é€‰æ‹©Dockeré•œåƒæ‹‰å–æº'
)
```

**2. åŠ¨æ€é€‰æ‹©é•œåƒæºï¼š**
```groovy
def registryMirror = ''
switch(params.DOCKER_REGISTRY_SOURCE) {
    case 'harbor-proxy':
        registryMirror = 'harbor-core.harbor/dockerhub-proxy'
        break
    case 'daocloud-mirror':
        registryMirror = 'docker.m.daocloud.io'
        break
    case 'docker-hub':
        registryMirror = ''  // ä¸ä½¿ç”¨é•œåƒ
        break
}
```

**3. æ¡ä»¶æ·»åŠ  `--registry-mirror` å‚æ•°ï¼š**
```bash
if [ -n "${registryMirror}" ]; then
    /kaniko/executor --registry-mirror=${registryMirror} ...
else
    /kaniko/executor ...  # ä¸åŠ --registry-mirrorå‚æ•°
fi
```

---

## éªŒè¯æ–¹æ³•

### 1. æŸ¥çœ‹Jenkinså‚æ•°

è¿è¡Œæ„å»ºæ—¶ï¼Œåº”è¯¥çœ‹åˆ°æ–°çš„å‚æ•°ï¼š

```
DOCKER_REGISTRY_SOURCE: [ä¸‹æ‹‰é€‰æ‹©]
  â—‹ harbor-proxy (é»˜è®¤)
  â—‹ daocloud-mirror
  â—‹ docker-hub
```

### 2. æŸ¥çœ‹æ„å»ºæ—¥å¿—

**é€‰æ‹© harbor-proxyï¼š**
```
é•œåƒæº: Harborä»£ç†(æœ¬åœ°ç¼“å­˜)
[INFO] Retrieving image from harbor-core.harbor/dockerhub-proxy
```

**é€‰æ‹© daocloud-mirrorï¼š**
```
é•œåƒæº: DaoCloudå›½å†…é•œåƒ
[INFO] Retrieving image from docker.m.daocloud.io
```

**é€‰æ‹© docker-hubï¼š**
```
é•œåƒæº: Docker Hubå®˜æ–¹æº
[INFO] Retrieving image from index.docker.io
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šHarborä»£ç†ä¸å¯ç”¨

**ç—‡çŠ¶ï¼š**
```
error pulling image from harbor-core.harbor/dockerhub-proxy
```

**è§£å†³ï¼š**
1. åˆ‡æ¢åˆ° `daocloud-mirror`
2. æ£€æŸ¥Harborä»£ç†é…ç½®
3. æŸ¥çœ‹Harboræ—¥å¿—

### é—®é¢˜2ï¼šæ‰€æœ‰é•œåƒæºéƒ½å¤±è´¥

**ç—‡çŠ¶ï¼š**
```
error pulling image: dial tcp: i/o timeout
```

**è§£å†³ï¼š**
1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
3. è”ç³»ç½‘ç»œç®¡ç†å‘˜

---

## æ€»ç»“

### âœ… æ–°å¢åŠŸèƒ½

- æ·»åŠ äº† `DOCKER_REGISTRY_SOURCE` å‚æ•°
- æ”¯æŒ3ç§é•œåƒæºé€‰æ‹©
- é»˜è®¤ä½¿ç”¨Harborä»£ç†ï¼ˆæœ€å¿«ï¼‰
- å¯ä»¥æ ¹æ®éœ€è¦åˆ‡æ¢

### ğŸ¯ ä¼˜åŠ¿

- âœ… çµæ´»æ€§ï¼šç”¨æˆ·å¯ä»¥é€‰æ‹©é•œåƒæº
- âœ… å®¹é”™æ€§ï¼šHarboræ•…éšœæ—¶å¯åˆ‡æ¢åˆ°å…¶ä»–æº
- âœ… æ€§èƒ½ï¼šé»˜è®¤ä½¿ç”¨æœ€å¿«çš„Harborä»£ç†
- âœ… å…¼å®¹æ€§ï¼šæ”¯æŒå®˜æ–¹æºç”¨äºç‰¹æ®Šéœ€æ±‚

### ğŸš€ æ¨èé…ç½®

**æ—¥å¸¸ä½¿ç”¨ï¼š**
```
DOCKER_REGISTRY_SOURCE: harbor-proxy
```

ç°åœ¨å¯ä»¥é‡æ–°è¿è¡Œæ„å»ºï¼Œé»˜è®¤ä¼šä½¿ç”¨Harborä»£ç†ï¼Œé€Ÿåº¦ä¼šéå¸¸å¿«ï¼
