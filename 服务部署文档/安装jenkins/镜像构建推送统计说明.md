# Jenkins 镜像构建和推送统计功能说明

## 功能概述

增强版Jenkinsfile现在提供详细的镜像构建和推送统计信息，包括：
- 镜像大小预估
- 总耗时（构建+推送）
- 推送速度估算
- 压缩和重试配置

---

## 输出示例

### 构建过程中的输出

```bash
>>> 预估镜像大小
  JAR文件: 45 MB
  基础镜像: 220 MB
  预估总大小: 265 MB

>>> 开始构建和推送镜像...
[Kaniko 构建输出...]

════════════════════════════════════════
镜像构建和推送统计
════════════════════════════════════════
模块名称: nms4cloud-platform
镜像大小: ~265 MB
总耗时:   3分25秒 (205秒)
推送速度: ~10 Mbps
压缩级别: Level 9 (最高)
重试次数: 最多3次
超时设置: 1800秒 (30分钟)
════════════════════════════════════════

✓ 镜像已推送到Harbor:
  harbor-core.harbor/library/nms4cloud-platform:123
  harbor-core.harbor/library/nms4cloud-platform:latest
```

---

## 统计指标说明

### 1. 镜像大小预估

**计算方法：**
```bash
镜像大小 = JAR文件大小 + 基础镜像大小
```

**组成部分：**
- **JAR文件**: 应用程序编译后的JAR包大小
- **基础镜像**: eclipse-temurin:21-jre (约220MB)

**注意：**
- 这是预估值，实际镜像大小可能因压缩而略小
- 不包括配置文件和其他资源文件（通常很小）

### 2. 总耗时

**包含内容：**
1. 镜像构建时间（Kaniko构建层）
2. 镜像压缩时间（Level 9压缩）
3. 推送到Harbor的时间（网络传输）
4. Harbor处理时间（接收和存储）

**格式：**
- `X分Y秒` - 易读格式
- `(Z秒)` - 精确秒数

### 3. 推送速度

**计算公式：**
```bash
推送速度 (Mbps) = 镜像大小 (MB) × 8 / 总耗时 (秒)
```

**说明：**
- 这是粗略估算，包含构建和推送的总时间
- 实际网络推送速度会更快（因为包含了构建时间）
- 用于评估整体性能和网络状况

**典型速度参考：**
- **10-20 Mbps**: 正常（本地Harbor）
- **5-10 Mbps**: 较慢（可能网络拥堵）
- **< 5 Mbps**: 很慢（检查网络或Harbor性能）

### 4. 压缩级别

**Level 9 (最高)**
- 最大压缩率，镜像最小
- 构建时间稍长
- 推送时间更短（镜像更小）
- 适合生产环境

### 5. 重试次数

**最多3次**
- Kaniko自动重试失败的推送
- 提高推送成功率
- 适应网络波动

### 6. 超时设置

**1800秒 (30分钟)**
- 防止构建无限期挂起
- 适合大型镜像（500MB+）
- 超时后自动失败

---

## 性能优化建议

### 如果推送速度慢（< 5 Mbps）

1. **检查网络连接**
   ```bash
   # 在Jenkins Pod中测试到Harbor的连接
   kubectl exec -it <jenkins-pod> -n jenkins -- ping harbor-core.harbor
   ```

2. **检查Harbor性能**
   ```bash
   # 查看Harbor资源使用
   kubectl top pods -n harbor
   ```

3. **调整压缩级别**
   - 如果构建时间过长，可以降低压缩级别
   - 修改 `--compression-level=9` 为 `--compression-level=6`

### 如果构建时间过长

1. **增加Kaniko容器资源**
   ```yaml
   resources:
     requests:
       cpu: 1000m      # 增加到 2000m
       memory: 2Gi     # 增加到 4Gi
     limits:
       cpu: 4000m      # 增加到 8000m
       memory: 4Gi     # 增加到 8Gi
   ```

2. **启用缓存**
   - 修改 `--cache=false` 为 `--cache=true`
   - 需要配置缓存存储

---

## 多模块构建统计

当构建多个模块时（BUILD_MODULE=all），会显示每个模块的统计：

```bash
════════════════════════════════════════
镜像构建和推送统计
════════════════════════════════════════
模块名称: nms4cloud-platform
镜像大小: ~265 MB
总耗时:   3分25秒 (205秒)
推送速度: ~10 Mbps
...

════════════════════════════════════════
镜像构建和推送统计
════════════════════════════════════════
模块名称: nms4cloud-biz
镜像大小: ~180 MB
总耗时:   2分15秒 (135秒)
推送速度: ~11 Mbps
...
```

---

## 故障排查

### 问题1: 推送速度显示为 0

**原因：**
- 镜像大小预估失败
- 总耗时为0（构建失败）

**解决：**
- 检查JAR文件是否存在
- 查看Kaniko构建日志

### 问题2: 总耗时异常长

**可能原因：**
1. 网络问题（推送慢）
2. Harbor性能问题
3. 镜像过大

**解决：**
- 查看Kaniko详细日志
- 检查Harbor存储空间
- 优化镜像大小（删除不必要的文件）

### 问题3: 推送超时

**错误信息：**
```
推送超时 (30分钟)
```

**解决：**
1. 增加超时时间
   ```bash
   timeout 3600 /kaniko/executor ...  # 改为60分钟
   ```

2. 检查网络连接
3. 减小镜像大小

---

## 统计数据的用途

### 1. 性能监控
- 跟踪构建时间趋势
- 识别性能瓶颈
- 优化构建流程

### 2. 容量规划
- 评估存储需求
- 规划网络带宽
- 调整资源配额

### 3. 故障诊断
- 快速定位慢速构建
- 识别网络问题
- 发现异常情况

---

## 相关文件

- `Jenkinsfile-nms4cloud-final` - 主项目构建文件
- `Jenkinsfile-nms4cloud-pos-java-optimized-v2` - POS项目构建文件

两个文件都包含相同的统计功能。
