# 镜像源配置方案

## 问题

国内环境无法访问：
- `docker.io` (Docker Hub)
- `gcr.io` (Google Container Registry)

## 解决方案

### 方案 1：使用 Docker Hub 代理（推荐）

```yaml
# Jenkins Agent
image: dockerproxy.com/jenkins/inbound-agent:latest

# Kaniko
image: dockerproxy.com/kaniko-project/executor:debug
```

### 方案 2：使用 Docker Hub 中国镜像

```yaml
# Jenkins Agent
image: docker.mirrors.ustc.edu.cn/jenkins/inbound-agent:latest

# Kaniko
image: docker.mirrors.ustc.edu.cn/kaniko-project/executor:debug
```

### 方案 3：使用阿里云容器镜像服务

需要先将镜像同步到阿里云：

```bash
# 1. 在有外网的机器上拉取镜像
docker pull jenkins/inbound-agent:latest
docker pull gcr.io/kaniko-project/executor:debug

# 2. 重新打标签
docker tag jenkins/inbound-agent:latest \
  registry.cn-hangzhou.aliyuncs.com/<你的命名空间>/jenkins-inbound-agent:latest

docker tag gcr.io/kaniko-project/executor:debug \
  registry.cn-hangzhou.aliyuncs.com/<你的命名空间>/kaniko-executor:debug

# 3. 推送到阿里云
docker push registry.cn-hangzhou.aliyuncs.com/<你的命名空间>/jenkins-inbound-agent:latest
docker push registry.cn-hangzhou.aliyuncs.com/<你的命名空间>/kaniko-executor:debug
```

### 方案 4：使用私有仓库（最稳定）

将镜像推送到你的私有仓库 `192.168.80.100:30500`：

```bash
# 1. 在有外网的机器上拉取镜像
docker pull jenkins/inbound-agent:latest
docker pull gcr.io/kaniko-project/executor:debug

# 2. 重新打标签
docker tag jenkins/inbound-agent:latest \
  192.168.80.100:30500/jenkins/inbound-agent:latest

docker tag gcr.io/kaniko-project/executor:debug \
  192.168.80.100:30500/kaniko-project/executor:debug

# 3. 推送到私有仓库
docker push 192.168.80.100:30500/jenkins/inbound-agent:latest
docker push 192.168.80.100:30500/kaniko-project/executor:debug
```

然后在 Jenkinsfile 中使用：

```yaml
containers:
- name: jnlp
  image: 192.168.80.100:30500/jenkins/inbound-agent:latest
  
- name: kaniko
  image: 192.168.80.100:30500/kaniko-project/executor:debug
```

### 方案 5：配置 RKE2 镜像加速

在 RKE2 节点上配置镜像加速：

```bash
# 编辑 /etc/rancher/rke2/registries.yaml
sudo tee /etc/rancher/rke2/registries.yaml <<EOF
mirrors:
  docker.io:
    endpoint:
      - "https://dockerproxy.com"
      - "https://docker.mirrors.ustc.edu.cn"
  gcr.io:
    endpoint:
      - "https://gcr.mirrors.ustc.edu.cn"
EOF

# 重启 RKE2
sudo systemctl restart rke2-server
# 或
sudo systemctl restart rke2-agent
```

## 测试镜像可用性

### 测试 dockerproxy.com

```bash
kubectl run test-jnlp --image=dockerproxy.com/jenkins/inbound-agent:latest --rm -it -- /bin/sh
kubectl run test-kaniko --image=dockerproxy.com/kaniko-project/executor:debug --rm -it -- /busybox/sh
```

### 测试 Docker Hub 中国镜像

```bash
kubectl run test-jnlp --image=docker.mirrors.ustc.edu.cn/jenkins/inbound-agent:latest --rm -it -- /bin/sh
```

### 测试私有仓库

```bash
kubectl run test-jnlp --image=192.168.80.100:30500/jenkins/inbound-agent:latest --rm -it -- /bin/sh
```

## 推荐方案

### 短期方案（快速测试）

使用 dockerproxy.com 或 docker.mirrors.ustc.edu.cn

### 长期方案（生产环境）

1. 将常用镜像推送到私有仓库 `192.168.80.100:30500`
2. 配置 RKE2 镜像加速
3. 在 Jenkinsfile 中使用私有仓库镜像

## 当前 Jenkinsfile-k8s 使用的镜像源

```yaml
# 当前使用 dockerproxy.com
containers:
- name: jnlp
  image: dockerproxy.com/jenkins/inbound-agent:latest
  
- name: kaniko
  image: dockerproxy.com/kaniko-project/executor:debug
```

如果 dockerproxy.com 不可用，请按照上述方案修改镜像地址。
