pipeline {
    agent any

    // 环境变量配置
    environment {
        // Maven配置
        MAVEN_HOME = tool 'Maven'
        MAVEN_OPTS = '-Xmx2048m'

        // JDK配置（使用镜像预装的 JDK 21）
        PATH = "${MAVEN_HOME}/bin:${env.PATH}"

        // 项目配置
        PROJECT_NAME = 'nms4cloud-pos-java'
        ARTIFACT_VERSION = '0.0.1-SNAPSHOT'

        // Git配置（阿里云效）
        GIT_CREDENTIAL_ID = 'aliyun-codeup-credentials'  // Jenkins中配置的凭据ID
        GIT_REPO_URL = 'https://codeup.aliyun.com/your-org/nms4cloud-pos-java.git'  // 替换为实际仓库地址
        GIT_BRANCH = "${params.GIT_BRANCH ?: 'master'}"

        // 部署配置
        DEPLOY_ENV = "${params.DEPLOY_ENV ?: 'dev'}"
    }

    // 参数化构建
    parameters {
        choice(
            name: 'DEPLOY_ENV',
            choices: ['dev', 'test', 'prod'],
            description: '选择部署环境'
        )
        choice(
            name: 'BUILD_MODULE',
            choices: [
                'all',
                'pos1starter',
                'pos2plugin',
                'pos3boot',
                'pos4cloud',
                'pos5sync',
                'pos6monitor',
                'pos8book',
                'pos9cash',
                'pos10printer'
            ],
            description: '选择构建模块'
        )
        string(
            name: 'GIT_BRANCH',
            defaultValue: 'master',
            description: '指定Git分支'
        )
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: true,
            description: '是否跳过单元测试'
        )
        booleanParam(
            name: 'CLEAN_BUILD',
            defaultValue: true,
            description: '是否清理构建'
        )
    }

    // 构建选项
    options {
        // 保留最近10次构建
        buildDiscarder(logRotator(numToKeepStr: '10'))
        // 禁止并发构建
        disableConcurrentBuilds()
        // 构建超时时间
        timeout(time: 30, unit: 'MINUTES')
        // 添加时间戳
        timestamps()
    }

    // 触发器配置
    triggers {
        // 定时构建（每天凌晨2点）
        cron('0 2 * * *')
        // Git轮询（每5分钟检查一次）
        pollSCM('H/5 * * * *')
    }

    stages {
        stage('环境检查') {
            steps {
                script {
                    echo "=== 环境信息 ==="
                    echo "Jenkins版本: ${env.JENKINS_VERSION}"
                    echo "构建编号: ${env.BUILD_NUMBER}"
                    echo "工作空间: ${env.WORKSPACE}"
                    echo "部署环境: ${DEPLOY_ENV}"
                    echo "构建模块: ${params.BUILD_MODULE}"

                    sh '''
                        echo "Java版本:"
                        java -version
                        echo "Maven版本:"
                        mvn -version
                        echo "Git版本:"
                        git --version
                    '''
                }
            }
        }

        stage('代码检出') {
            steps {
                script {
                    echo "=== 从阿里云效拉取最新代码 ==="
                    echo "仓库地址: ${GIT_REPO_URL}"
                    echo "分支: ${GIT_BRANCH}"

                    // 清理工作空间
                    deleteDir()

                    // 从阿里云效检出代码
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: "*/${GIT_BRANCH}"]],
                        doGenerateSubmoduleConfigurations: false,
                        extensions: [
                            [$class: 'CloneOption', depth: 1, noTags: false, reference: '', shallow: true],
                            [$class: 'CheckoutOption', timeout: 20]
                        ],
                        submoduleCfg: [],
                        userRemoteConfigs: [[
                            credentialsId: "${GIT_CREDENTIAL_ID}",
                            url: "${GIT_REPO_URL}"
                        ]]
                    ])

                    // 显示最近的提交信息
                    sh '''
                        echo "=== Git信息 ==="
                        echo "最近的提交:"
                        git log -3 --pretty=format:"%h - %an, %ar : %s" --graph
                        echo ""
                        echo ""
                        echo "当前分支:"
                        git branch -a
                        echo ""
                        echo "当前提交:"
                        git rev-parse HEAD
                        echo ""
                        echo "=== 项目结构检查 ==="
                        echo "当前目录:"
                        pwd
                        echo ""
                        echo "当前目录内容:"
                        ls -la
                        echo ""
                        echo "查找所有 pom.xml 文件:"
                        find . -name "pom.xml" -type f | head -20
                    '''
                }
            }
        }

        stage('Maven构建') {
            steps {
                script {
                    echo "=== Maven构建 ==="

                    def cleanCmd = params.CLEAN_BUILD ? 'clean' : ''
                    def skipTests = params.SKIP_TESTS ? '-DskipTests' : ''
                    def buildModule = ''

                    // 根据选择的模块构建
                    switch(params.BUILD_MODULE) {
                        case 'pos1starter':
                            buildModule = '-pl nms4cloud-pos1starter -am'
                            break
                        case 'pos2plugin':
                            buildModule = '-pl nms4cloud-pos2plugin/nms4cloud-pos2plugin-app -am'
                            break
                        case 'pos3boot':
                            buildModule = '-pl nms4cloud-pos3boot/nms4cloud-pos3boot-app -am'
                            break
                        case 'pos4cloud':
                            buildModule = '-pl nms4cloud-pos4cloud/nms4cloud-pos4cloud-app -am'
                            break
                        case 'pos5sync':
                            buildModule = '-pl nms4cloud-pos5sync/nms4cloud-pos5sync-app -am'
                            break
                        case 'pos6monitor':
                            buildModule = '-pl nms4cloud-pos6monitor -am'
                            break
                        case 'pos8book':
                            buildModule = '-pl nms4cloud-pos8book/nms4cloud-pos8book-app -am'
                            break
                        case 'pos9cash':
                            buildModule = '-pl nms4cloud-pos9cash/nms4cloud-pos9cash-app -am'
                            break
                        case 'pos10printer':
                            buildModule = '-pl nms4cloud-pos10printer/nms4cloud-pos10printer-app -am'
                            break
                        default:
                            buildModule = ''
                    }

                    sh """
                        mvn ${cleanCmd} install ${buildModule} ${skipTests} \
                        -Dmaven.compile.fork=true \
                        -T 1C
                    """
                }
            }
        }

        stage('单元测试') {
            when {
                expression { !params.SKIP_TESTS }
            }
            steps {
                script {
                    echo "=== 执行单元测试 ==="
                    sh 'mvn test'
                }
            }
            post {
                always {
                    // 发布测试报告
                    junit '**/target/surefire-reports/*.xml'
                }
            }
        }

        stage('代码质量检查') {
            steps {
                script {
                    echo "=== 代码质量检查 ==="
                    // 如果配置了SonarQube，可以在这里添加
                    // sh 'mvn sonar:sonar'
                    echo "跳过代码质量检查（未配置SonarQube）"
                }
            }
        }

        stage('打包构建产物') {
            steps {
                script {
                    echo "=== 打包构建产物 ==="

                    // 创建构建产物目录
                    sh '''
                        mkdir -p ${WORKSPACE}/artifacts
                        mkdir -p ${WORKSPACE}/artifacts/libs
                    '''

                    // 根据构建模块复制jar包
                    if (params.BUILD_MODULE == 'all' || params.BUILD_MODULE == 'pos1starter') {
                        sh '''
                            if [ -f nms4cloud-pos1starter/target/*.jar ]; then
                                cp nms4cloud-pos1starter/target/*.jar ${WORKSPACE}/artifacts/
                            fi
                        '''
                    }

                    if (params.BUILD_MODULE == 'all' || params.BUILD_MODULE == 'pos2plugin') {
                        sh '''
                            if [ -f nms4cloud-pos2plugin/nms4cloud-pos2plugin-app/target/*.jar ]; then
                                cp nms4cloud-pos2plugin/nms4cloud-pos2plugin-app/target/*.jar ${WORKSPACE}/artifacts/
                            fi
                        '''
                    }

                    if (params.BUILD_MODULE == 'all' || params.BUILD_MODULE == 'pos3boot') {
                        sh '''
                            if [ -f nms4cloud-pos3boot/nms4cloud-pos3boot-app/target/*.jar ]; then
                                cp nms4cloud-pos3boot/nms4cloud-pos3boot-app/target/*.jar ${WORKSPACE}/artifacts/
                                cp -r nms4cloud-pos3boot/nms4cloud-pos3boot-app/target/libs/* ${WORKSPACE}/artifacts/libs/ 2>/dev/null || true
                            fi
                        '''
                    }

                    if (params.BUILD_MODULE == 'all' || params.BUILD_MODULE == 'pos4cloud') {
                        sh '''
                            if [ -f nms4cloud-pos4cloud/nms4cloud-pos4cloud-app/target/*.jar ]; then
                                cp nms4cloud-pos4cloud/nms4cloud-pos4cloud-app/target/*.jar ${WORKSPACE}/artifacts/
                            fi
                        '''
                    }

                    if (params.BUILD_MODULE == 'all' || params.BUILD_MODULE == 'pos5sync') {
                        sh '''
                            if [ -f nms4cloud-pos5sync/nms4cloud-pos5sync-app/target/*.jar ]; then
                                cp nms4cloud-pos5sync/nms4cloud-pos5sync-app/target/*.jar ${WORKSPACE}/artifacts/
                            fi
                        '''
                    }

                    if (params.BUILD_MODULE == 'all' || params.BUILD_MODULE == 'pos6monitor') {
                        sh '''
                            if [ -f nms4cloud-pos6monitor/target/*.jar ]; then
                                cp nms4cloud-pos6monitor/target/*.jar ${WORKSPACE}/artifacts/
                            fi
                        '''
                    }

                    if (params.BUILD_MODULE == 'all' || params.BUILD_MODULE == 'pos8book') {
                        sh '''
                            if [ -f nms4cloud-pos8book/nms4cloud-pos8book-app/target/*.jar ]; then
                                cp nms4cloud-pos8book/nms4cloud-pos8book-app/target/*.jar ${WORKSPACE}/artifacts/
                            fi
                        '''
                    }

                    if (params.BUILD_MODULE == 'all' || params.BUILD_MODULE == 'pos9cash') {
                        sh '''
                            if [ -f nms4cloud-pos9cash/nms4cloud-pos9cash-app/target/*.jar ]; then
                                cp nms4cloud-pos9cash/nms4cloud-pos9cash-app/target/*.jar ${WORKSPACE}/artifacts/
                            fi
                        '''
                    }

                    if (params.BUILD_MODULE == 'all' || params.BUILD_MODULE == 'pos10printer') {
                        sh '''
                            if [ -f nms4cloud-pos10printer/nms4cloud-pos10printer-app/target/*.jar ]; then
                                cp nms4cloud-pos10printer/nms4cloud-pos10printer-app/target/*.jar ${WORKSPACE}/artifacts/
                            fi
                        '''
                    }
                }
            }
        }

        stage('归档构建产物') {
            steps {
                script {
                    echo "=== 归档构建产物 ==="
                    archiveArtifacts artifacts: 'artifacts/**/*.jar', fingerprint: true
                }
            }
        }

        stage('部署') {
            when {
                expression { params.DEPLOY_ENV != 'prod' || env.BRANCH_NAME == 'master' }
            }
            steps {
                script {
                    echo "=== 部署到 ${DEPLOY_ENV} 环境 ==="

                    // 这里添加具体的部署逻辑
                    // 例如：SSH到目标服务器，停止服务，复制jar包，启动服务
                    echo "部署逻辑待实现"

                    // 示例部署脚本
                    /*
                    sh """
                        ssh user@server 'systemctl stop nms4pos'
                        scp artifacts/*.jar user@server:/opt/nms4pos/
                        ssh user@server 'systemctl start nms4pos'
                    """
                    */
                }
            }
        }
    }

    post {
        success {
            echo "=== 构建成功 ==="
            // 可以添加通知逻辑，如发送邮件、钉钉、企业微信等
        }
        failure {
            echo "=== 构建失败 ==="
            // 可以添加失败通知逻辑
        }
        always {
            echo "=== 清理工作空间 ==="
            // 清理临时文件
            cleanWs(
                deleteDirs: true,
                patterns: [
                    [pattern: 'artifacts/**', type: 'INCLUDE']
                ]
            )
        }
    }
}
