# 镜像构建推送优化 - 输出示例

## 优化前的输出

```
07:33:03  + /kaniko/executor --context=... --destination=...
07:33:05  INFO[0002] Retrieving image manifest eclipse-temurin:21-jre
07:33:08  INFO[0005] Built cross stage deps: map[]
...
07:35:00  INFO[0109] Pushing image to crpi-xxx.cn-hangzhou.personal.cr.aliyuncs.com/...
（卡住，没有任何进度信息，用户不知道要等多久）
```

**问题：**
- ❌ 不知道镜像有多大
- ❌ 不知道要等多久
- ❌ 没有超时保护
- ❌ 推送失败没有重试

---

## 优化后的输出

```bash
╔════════════════════════════════════════╗
║         镜像大小预估                    ║
╚════════════════════════════════════════╝
>>> JAR 文件大小:
    nms4cloud-pos4cloud-app-0.0.1-SNAPSHOT.jar: 85M
    总计: 85 MB

>>> 配置文件大小: 2 MB

>>> 基础镜像大小: 220 MB (eclipse-temurin:21-jre)

>>> 预估镜像总大小: 307 MB

>>> 预估推送时间: 5-10 分钟

>>> 开始构建和推送镜像...
INFO[0002] Retrieving image manifest eclipse-temurin:21-jre
INFO[0005] Built cross stage deps: map[]
INFO[0109] COPY target/*.jar app.jar
INFO[0112] COPY src/main/resources/* config/
INFO[0115] Pushing image to crpi-xxx.cn-hangzhou.personal.cr.aliyuncs.com/...
INFO[0120] Pushed layer sha256:abc123...
INFO[0125] Pushed layer sha256:def456...
...
INFO[0480] Pushed image to crpi-xxx.cn-hangzhou.personal.cr.aliyuncs.com/lgy-images/nms4cloud-pos4cloud:26
INFO[0485] Pushed image to crpi-xxx.cn-hangzhou.personal.cr.aliyuncs.com/lgy-images/nms4cloud-pos4cloud:latest

╔════════════════════════════════════════╗
║         推送完成统计                    ║
╚════════════════════════════════════════╝
>>> 推送耗时: 8 分 5 秒
>>> 平均速度: 0 MB/s (651 KB/s)
⚠ 推送速度较慢，建议部署本地镜像仓库

✓ 镜像构建并推送成功: crpi-xxx.cn-hangzhou.personal.cr.aliyuncs.com/lgy-images/nms4cloud-pos4cloud:26
```

**优点：**
- ✅ 推送前显示预估大小和时间
- ✅ 推送后显示实际耗时和速度
- ✅ 30 分钟超时保护
- ✅ 失败自动重试 3 次
- ✅ 启用 gzip 压缩
- ✅ 速度慢时给出建议

---

## 不同镜像大小的推送时间对比

### 阿里云个人版（带宽约 0.5-1 MB/s）

| 镜像大小 | 预估时间 | 实际时间 | 建议 |
|---------|---------|---------|------|
| 150 MB (Alpine) | 3-5 分钟 | 4-8 分钟 | ✅ 可接受 |
| 300 MB (标准 JRE) | 5-10 分钟 | 8-15 分钟 | ⚠ 较慢 |
| 500 MB (大型应用) | 8-17 分钟 | 15-30 分钟 | ❌ 太慢，需优化 |
| 1 GB+ | 17-34 分钟 | 30-60 分钟 | ❌ 不可接受 |

### 本地镜像仓库（带宽约 100-500 MB/s）

| 镜像大小 | 推送时间 |
|---------|---------|
| 150 MB | 1-3 秒 |
| 300 MB | 3-6 秒 |
| 500 MB | 5-10 秒 |
| 1 GB+ | 10-20 秒 |

---

## 镜像大小优化建议

### 1. 使用 Alpine 基础镜像

```dockerfile
# 原来 (220 MB)
FROM eclipse-temurin:21-jre

# 优化后 (170 MB)
FROM eclipse-temurin:21-jre-alpine

# 节省: 50 MB
# 推送时间减少: 约 30%
```

### 2. 不要复制不必要的文件

```dockerfile
# ❌ 错误：复制整个 resources 目录
COPY src/main/resources/* config/

# ✅ 正确：只复制必要的配置文件
# Spring Boot 已经将配置打包到 JAR 中，无需额外复制
```

### 3. 使用 .dockerignore

```
# .dockerignore
.git
.idea
*.md
target/classes
target/test-classes
src/test
*.log
```

### 4. 使用多阶段构建 + 分层

```dockerfile
FROM eclipse-temurin:21-jre-alpine as builder
WORKDIR /app
COPY target/*.jar app.jar
RUN java -Djarmode=layertools -jar app.jar extract

FROM eclipse-temurin:21-jre-alpine
WORKDIR /app

# 分层复制（依赖层变化少，可以利用缓存）
COPY --from=builder /app/dependencies/ ./
COPY --from=builder /app/spring-boot-loader/ ./
COPY --from=builder /app/snapshot-dependencies/ ./
COPY --from=builder /app/application/ ./

ENTRYPOINT ["java", "org.springframework.boot.loader.JarLauncher"]
```

**效果：**
- 首次推送：仍需 8-15 分钟
- 后续推送：只推送变化的层，约 1-3 分钟

---

## 推送速度慢的根本解决方案

### 方案 1: 部署本地 Docker Registry（推荐）

**效果：**
- 推送时间：从 15 分钟降到 10 秒
- 部署时间：从 5 分钟降到 10 秒
- 总体提升：90% 以上

**成本：**
- 存储：50-100 GB
- 维护：低

### 方案 2: 升级阿里云企业版

**效果：**
- 推送时间：从 15 分钟降到 3-5 分钟
- 带宽：从 0.5-1 MB/s 提升到 5-10 MB/s

**成本：**
- 费用：¥300-500/月

### 方案 3: 使用 Harbor

**效果：**
- 推送到 Harbor：10 秒
- Harbor 自动同步到阿里云（后台）
- 不阻塞流水线

**成本：**
- 存储：100 GB+
- 维护：中等

---

## 监控推送进度（可选）

如果想实时查看推送进度，可以在另一个终端执行：

```bash
# 进入 Kaniko 容器
kubectl exec -it <kaniko-pod> -n jenkins -- sh

# 查看网络流量
watch -n 1 'cat /proc/net/dev | grep eth0'

# 或者使用 iftop（需要安装）
apk add iftop
iftop -i eth0
```

---

## 总结

### 已实施的优化

✅ 推送前显示镜像大小预估
✅ 推送后显示实际耗时和速度
✅ 30 分钟超时保护
✅ 失败自动重试 3 次
✅ 启用 gzip 压缩
✅ 一次推送两个标签（高效）

### 下一步建议

1. **短期**：将基础镜像改为 Alpine（减少 50MB）
2. **中期**：部署本地 Docker Registry（推送时间降低 90%）
3. **长期**：使用 Harbor 企业级镜像管理

### 预期效果

| 优化阶段 | 镜像大小 | 推送时间 | 改善 |
|---------|---------|---------|------|
| 当前 | 307 MB | 15 分钟 | - |
| + Alpine | 257 MB | 10 分钟 | 33% ↓ |
| + 本地仓库 | 257 MB | 10 秒 | 99% ↓ |
