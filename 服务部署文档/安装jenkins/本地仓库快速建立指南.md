# Docker Registry 本地仓库建立指南（快速版）

## 前提条件

- ✅ 已安装 RKE2 集群
- ✅ 已安装 kubectl 并配置好连接
- ✅ 集群有 Longhorn 或其他存储类

## 方式一：自动部署（推荐）

### 1. 上传文件到 RKE2 节点

将以下文件上传到你的 RKE2 master 节点：
- `docker-registry-simple.yaml`
- `deploy-registry.sh`

### 2. 执行部署脚本

```bash
# SSH 登录到 RKE2 节点
ssh root@<rke2-node-ip>

# 赋予执行权限
chmod +x deploy-registry.sh

# 执行部署
./deploy-registry.sh
```

脚本会自动：
- ✅ 检查环境
- ✅ 部署 Registry
- ✅ 等待 Pod 就绪
- ✅ 显示访问地址
- ✅ 提供配置命令

---

## 方式二：手动部署（逐步操作）

### 步骤 1：检查环境

```bash
# 检查 kubectl 连接
kubectl cluster-info

# 检查存储类
kubectl get storageclass

# 应该看到 longhorn 或其他存储类
```

### 步骤 2：部署 Registry

```bash
# 应用部署文件
kubectl apply -f docker-registry-simple.yaml

# 输出：
# namespace/docker-registry created
# persistentvolumeclaim/registry-data created
# deployment.apps/docker-registry created
# service/docker-registry created
# service/docker-registry-nodeport created
```

### 步骤 3：检查部署状态

```bash
# 查看 Pod 状态
kubectl get pods -n docker-registry

# 应该看到：
# NAME                              READY   STATUS    RESTARTS   AGE
# docker-registry-xxxxxxxxxx-xxxxx   1/1     Running   0          1m

# 查看 Service
kubectl get svc -n docker-registry

# 应该看到：
# NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
# docker-registry             ClusterIP   10.43.xxx.xxx   <none>        5000/TCP         1m
# docker-registry-nodeport    NodePort    10.43.xxx.xxx   <none>        5000:30500/TCP   1m
```

### 步骤 4：获取访问地址

```bash
# 获取节点 IP
kubectl get nodes -o wide

# 记录 INTERNAL-IP，例如：192.168.1.100
```

**访问地址：**
- 集群内：`http://docker-registry.docker-registry.svc.cluster.local:5000`
- 外部访问：`http://<节点IP>:30500`

### 步骤 5：测试访问

```bash
# 测试 API（在任意能访问节点的机器上）
curl http://192.168.1.100:30500/v2/

# 应该返回：{}
```

### 步骤 6：配置 RKE2 节点信任仓库

**在每个 RKE2 节点上执行：**

```bash
# 创建 registries.yaml
cat <<EOF > /etc/rancher/rke2/registries.yaml
mirrors:
  "192.168.1.100:30500":
    endpoint:
      - "http://192.168.1.100:30500"
configs:
  "192.168.1.100:30500":
    tls:
      insecure_skip_verify: true
EOF

# 重启 RKE2
# Master 节点：
systemctl restart rke2-server

# Worker 节点：
systemctl restart rke2-agent

# 等待重启完成（约 1-2 分钟）
```

### 步骤 7：测试推送镜像

```bash
# 1. 拉取测试镜像
docker pull nginx:alpine

# 2. 打标签（使用你的节点 IP）
docker tag nginx:alpine 192.168.1.100:30500/nginx:alpine

# 3. 推送镜像
docker push 192.168.1.100:30500/nginx:alpine

# 输出：
# The push refers to repository [192.168.1.100:30500/nginx]
# ...
# alpine: digest: sha256:xxx size: 1234

# 4. 验证镜像已推送
curl http://192.168.1.100:30500/v2/_catalog

# 应该返回：
# {"repositories":["nginx"]}

# 5. 查看镜像标签
curl http://192.168.1.100:30500/v2/nginx/tags/list

# 应该返回：
# {"name":"nginx","tags":["alpine"]}
```

---

## 常见问题

### Q1: 推送镜像时报错 "http: server gave HTTP response to HTTPS client"

**原因：** Docker 默认使用 HTTPS，但我们的仓库是 HTTP。

**解决方法：**

**Linux：**
```bash
# 编辑 Docker daemon 配置
sudo vim /etc/docker/daemon.json

# 添加：
{
  "insecure-registries": ["192.168.1.100:30500"]
}

# 重启 Docker
sudo systemctl restart docker
```

**Windows Docker Desktop：**
1. 打开 Docker Desktop
2. Settings → Docker Engine
3. 添加配置：
```json
{
  "insecure-registries": ["192.168.1.100:30500"]
}
```
4. Apply & Restart

### Q2: Pod 一直处于 Pending 状态

**原因：** PVC 无法绑定。

**检查：**
```bash
# 查看 PVC 状态
kubectl get pvc -n docker-registry

# 查看详细信息
kubectl describe pvc registry-data -n docker-registry

# 检查存储类
kubectl get storageclass
```

**解决：**
- 确保集群有可用的存储类
- 修改 `docker-registry-simple.yaml` 中的 `storageClassName`

### Q3: 无法访问 NodePort

**检查：**
```bash
# 检查防火墙
firewall-cmd --list-ports

# 开放端口（如果需要）
firewall-cmd --permanent --add-port=30500/tcp
firewall-cmd --reload
```

### Q4: 如何删除仓库

```bash
# 删除所有资源
kubectl delete -f docker-registry-simple.yaml

# 或者
kubectl delete namespace docker-registry
```

---

## 下一步

部署成功后，你需要：

1. **配置 Jenkins 使用本地仓库**
   - 修改 Jenkinsfile 中的 `DOCKER_REGISTRY`
   - 创建 Kubernetes Secret

2. **配置 Kaniko 推送到本地仓库**
   - 修改 `--destination` 参数

3. **配置应用从本地仓库拉取镜像**
   - 修改 Deployment 的 `image` 字段

详细配置请参考：`本地镜像仓库部署指南.md`

---

## 快速命令参考

```bash
# 查看 Registry 日志
kubectl logs -n docker-registry -l app=docker-registry -f

# 查看仓库中的镜像
curl http://<节点IP>:30500/v2/_catalog

# 查看某个镜像的标签
curl http://<节点IP>:30500/v2/<镜像名>/tags/list

# 重启 Registry
kubectl rollout restart deployment docker-registry -n docker-registry

# 查看存储使用情况
kubectl exec -n docker-registry <pod-name> -- du -sh /var/lib/registry
```

---

## 架构图

```
┌─────────────────────────────────────────┐
│         RKE2 Kubernetes 集群             │
│                                          │
│  ┌────────────────────────────────────┐ │
│  │  Namespace: docker-registry        │ │
│  │                                    │ │
│  │  ┌──────────────────────────────┐ │ │
│  │  │  Pod: docker-registry        │ │ │
│  │  │  Image: registry:2           │ │ │
│  │  │  Port: 5000                  │ │ │
│  │  └──────────────────────────────┘ │ │
│  │              ↓                     │ │
│  │  ┌──────────────────────────────┐ │ │
│  │  │  PVC: registry-data          │ │ │
│  │  │  Storage: 50Gi (Longhorn)    │ │ │
│  │  └──────────────────────────────┘ │ │
│  │              ↓                     │ │
│  │  ┌──────────────────────────────┐ │ │
│  │  │  Service: ClusterIP          │ │ │
│  │  │  Port: 5000                  │ │ │
│  │  └──────────────────────────────┘ │ │
│  │              ↓                     │ │
│  │  ┌──────────────────────────────┐ │ │
│  │  │  Service: NodePort           │ │ │
│  │  │  NodePort: 30500             │ │ │
│  │  └──────────────────────────────┘ │ │
│  └────────────────────────────────────┘ │
└─────────────────────────────────────────┘
                 ↓
         外部访问：<节点IP>:30500
```

---

## 总结

**部署本地仓库只需 3 步：**

1. ✅ `kubectl apply -f docker-registry-simple.yaml`
2. ✅ 配置 RKE2 节点信任仓库
3. ✅ 测试推送镜像

**访问地址：**
- 集群内：`docker-registry.docker-registry.svc.cluster.local:5000`
- 外部：`<节点IP>:30500`

**特点：**
- 无需认证（简化配置）
- 使用 HTTP（内网环境）
- 使用 NodePort（方便访问）
- 持久化存储（数据不丢失）
