# ä½¿ç”¨é˜¿é‡Œäº‘æ•ˆåªè¯»ä»£ç åº“ + Jenkins + é˜¿é‡Œäº‘ä¸ªäººé•œåƒä»“åº“å®Œæ•´æ–¹æ¡ˆ

## ğŸ“‹ åœºæ™¯è¯´æ˜

**ä½ çš„æƒ…å†µï¼š**
- âœ… é˜¿é‡Œäº‘æ•ˆï¼ˆCodeupï¼‰ä»£ç åº“ï¼šåªæœ‰è¯»å–æƒé™ï¼Œä¸èƒ½ä¿®æ”¹
- âœ… Jenkinsï¼šéƒ¨ç½²åœ¨ RKE2/Rancher é›†ç¾¤ä¸­
- âœ… é˜¿é‡Œäº‘ä¸ªäººå…è´¹ç‰ˆé•œåƒä»“åº“ï¼šç”¨äºå­˜å‚¨æ„å»ºçš„é•œåƒ

**ç›®æ ‡ï¼š**
- ä»é˜¿é‡Œäº‘æ•ˆæ‹‰å–ä»£ç 
- åœ¨ Jenkins ä¸­æ„å»º
- æ¨é€é•œåƒåˆ°é˜¿é‡Œäº‘ä¸ªäººé•œåƒä»“åº“

**ç»“è®ºï¼šå®Œå…¨å¯è¡Œï¼** âœ…

---

## ğŸ” æ­¥éª¤ 1ï¼šè·å–é˜¿é‡Œäº‘æ•ˆè®¿é—®ä»¤ç‰Œ

### 1.1 åˆ›å»ºåªè¯»è®¿é—®ä»¤ç‰Œ

1. **ç™»å½•é˜¿é‡Œäº‘æ•ˆ**
   - è®¿é—®ï¼šhttps://codeup.aliyun.com/
   - ç™»å½•ä½ çš„è´¦å·

2. **åˆ›å»ºä¸ªäººè®¿é—®ä»¤ç‰Œ**
   - ç‚¹å‡»å³ä¸Šè§’å¤´åƒ â†’ ä¸ªäººè®¾ç½®
   - å·¦ä¾§èœå•ï¼šè®¿é—®ä»¤ç‰Œï¼ˆAccess Tokensï¼‰
   - ç‚¹å‡»"åˆ›å»ºæ–°ä»¤ç‰Œ"

3. **é…ç½®ä»¤ç‰Œæƒé™**
   ```
   ä»¤ç‰Œåç§°ï¼šjenkins-readonly
   è¿‡æœŸæ—¶é—´ï¼šæ°¸ä¸è¿‡æœŸï¼ˆæˆ–æ ¹æ®éœ€è¦è®¾ç½®ï¼‰
   æƒé™èŒƒå›´ï¼š
     âœ… read_repositoryï¼ˆè¯»å–ä»“åº“ï¼‰
     âŒ write_repositoryï¼ˆä¸éœ€è¦ï¼‰
     âŒ apiï¼ˆä¸éœ€è¦ï¼‰
   ```

4. **ä¿å­˜ä»¤ç‰Œ**
   - å¤åˆ¶ç”Ÿæˆçš„ä»¤ç‰Œï¼ˆåªæ˜¾ç¤ºä¸€æ¬¡ï¼ï¼‰
   - æ ¼å¼ç±»ä¼¼ï¼š`glpat-xxxxxxxxxxxxxxxxxxxx`

### 1.2 åœ¨ Jenkins ä¸­é…ç½®å‡­è¯

**æ–¹æ³• 1ï¼šé€šè¿‡ Jenkins UIï¼ˆæ¨èï¼‰**

1. ç™»å½• Jenkins â†’ ç³»ç»Ÿç®¡ç† â†’ å‡­æ®ç®¡ç†
2. é€‰æ‹© `(global)` åŸŸ â†’ æ·»åŠ å‡­æ®
3. å¡«å†™ä¿¡æ¯ï¼š
   ```
   ç±»å‹ï¼šUsername with password
   èŒƒå›´ï¼šå…¨å±€
   ç”¨æˆ·åï¼šä½ çš„é˜¿é‡Œäº‘æ•ˆç”¨æˆ·åï¼ˆé‚®ç®±æˆ–ç”¨æˆ·åï¼‰
   å¯†ç ï¼šåˆšæ‰å¤åˆ¶çš„è®¿é—®ä»¤ç‰Œ
   IDï¼šaliyun-codeup-token
   æè¿°ï¼šé˜¿é‡Œäº‘æ•ˆåªè¯»è®¿é—®ä»¤ç‰Œ
   ```
4. ç‚¹å‡»"ç¡®å®š"ä¿å­˜

**æ–¹æ³• 2ï¼šé€šè¿‡ Kubernetes Secretï¼ˆå¯é€‰ï¼‰**

```bash
# åˆ›å»º Jenkins å‡­è¯ Secret
kubectl create secret generic aliyun-codeup-token \
  --from-literal=username='ä½ çš„é˜¿é‡Œäº‘æ•ˆç”¨æˆ·å' \
  --from-literal=password='è®¿é—®ä»¤ç‰Œ' \
  --namespace=jenkins

# åœ¨ Jenkins ä¸­é…ç½®ä½¿ç”¨è¿™ä¸ª Secret
```

---

## ğŸ³ æ­¥éª¤ 2ï¼šé…ç½®é˜¿é‡Œäº‘ä¸ªäººé•œåƒä»“åº“

### 2.1 è·å–é•œåƒä»“åº“ä¿¡æ¯

1. **ç™»å½•é˜¿é‡Œäº‘æ§åˆ¶å°**
   - è®¿é—®ï¼šhttps://cr.console.aliyun.com/
   - é€‰æ‹©"ä¸ªäººç‰ˆ"

2. **æŸ¥çœ‹è®¿é—®å‡­è¯**
   - å·¦ä¾§èœå•ï¼šè®¿é—®å‡­è¯
   - è®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š
     ```
     ä»“åº“åœ°å€ï¼šcrpi-xxxxxxxxx.cn-hangzhou.personal.cr.aliyuncs.com
     ç”¨æˆ·åï¼šä½ çš„é˜¿é‡Œäº‘è´¦å·
     å¯†ç ï¼šç‚¹å‡»"è®¾ç½®å›ºå®šå¯†ç "æˆ–"é‡ç½®å¯†ç "
     ```

3. **åˆ›å»ºå‘½åç©ºé—´ï¼ˆå¦‚æœæ²¡æœ‰ï¼‰**
   - å·¦ä¾§èœå•ï¼šå‘½åç©ºé—´
   - åˆ›å»ºå‘½åç©ºé—´ï¼š`lgy-images`ï¼ˆæˆ–å…¶ä»–åç§°ï¼‰

### 2.2 åˆ›å»º Kubernetes Secret

**ç¼–è¾‘è„šæœ¬ï¼š**
```bash
# ç¼–è¾‘ åˆ›å»ºé˜¿é‡Œäº‘é•œåƒä»“åº“å‡­è¯.sh
vim F:\pythonèµ„æ–™\æœåŠ¡éƒ¨ç½²æ–‡æ¡£\å®‰è£…jenkins\åˆ›å»ºé˜¿é‡Œäº‘é•œåƒä»“åº“å‡­è¯.sh

# ä¿®æ”¹ä»¥ä¸‹å‚æ•°
REGISTRY_SERVER="crpi-csgbt2t7j15cj178.cn-hangzhou.personal.cr.aliyuncs.com"
REGISTRY_USERNAME="ä½ çš„é˜¿é‡Œäº‘è´¦å·"
REGISTRY_PASSWORD="ä½ çš„é•œåƒä»“åº“å¯†ç "
```

**è¿è¡Œè„šæœ¬ï¼š**
```bash
bash F:\pythonèµ„æ–™\æœåŠ¡éƒ¨ç½²æ–‡æ¡£\å®‰è£…jenkins\åˆ›å»ºé˜¿é‡Œäº‘é•œåƒä»“åº“å‡­è¯.sh
```

**éªŒè¯ï¼š**
```bash
# æŸ¥çœ‹ Secret
kubectl get secret aliyun-registry-secret -n jenkins

# æµ‹è¯•æ‹‰å–é•œåƒï¼ˆå¦‚æœä»“åº“ä¸­å·²æœ‰é•œåƒï¼‰
kubectl run test-pull --rm -it --restart=Never \
  --image=crpi-xxx.cn-hangzhou.personal.cr.aliyuncs.com/lgy-images/test:latest \
  --image-pull-secrets=aliyun-registry-secret \
  -n jenkins
```

---

## ğŸ“ æ­¥éª¤ 3ï¼šé…ç½® Jenkinsfile

ä½ çš„ `Jenkinsfile-nms4cloud-final` å·²ç»é…ç½®å¥½äº†ï¼Œåªéœ€ç¡®è®¤ä»¥ä¸‹é…ç½®ï¼š

### 3.1 Git ä»“åº“é…ç½®

```groovy
environment {
    // Git é…ç½®
    GIT_CREDENTIAL_ID = 'aliyun-codeup-token'  // âœ… ä½¿ç”¨æ­¥éª¤ 1 åˆ›å»ºçš„å‡­è¯
    GIT_BRANCH = "${params.GIT_BRANCH ?: 'master'}"

    // Git ä»“åº“åœ°å€ï¼ˆåªè¯»ï¼‰
    REPO_MAIN = 'https://codeup.aliyun.com/ä½ çš„ç»„ç»‡/ä½ çš„é¡¹ç›®.git'
    REPO_BI = 'https://codeup.aliyun.com/ä½ çš„ç»„ç»‡/nms4cloud-bi.git'
    REPO_WMS = 'https://codeup.aliyun.com/ä½ çš„ç»„ç»‡/nms4cloud-wms.git'
}
```

### 3.2 Docker é•œåƒä»“åº“é…ç½®

```groovy
environment {
    // é˜¿é‡Œäº‘ä¸ªäººé•œåƒä»“åº“é…ç½®
    DOCKER_REGISTRY = 'crpi-csgbt2t7j15cj178.cn-hangzhou.personal.cr.aliyuncs.com'
    DOCKER_NAMESPACE = 'lgy-images'  // âœ… ä½ åœ¨é˜¿é‡Œäº‘åˆ›å»ºçš„å‘½åç©ºé—´
    DOCKER_IMAGE_TAG = "${env.BUILD_NUMBER}"
}
```

### 3.3 Pod é…ç½®

```yaml
spec:
  imagePullSecrets:
  - name: aliyun-registry-secret  # âœ… ä½¿ç”¨æ­¥éª¤ 2 åˆ›å»ºçš„ Secret

  containers:
  - name: kaniko
    volumeMounts:
    - name: docker-config
      mountPath: /kaniko/.docker

  volumes:
  - name: docker-config
    secret:
      secretName: aliyun-registry-secret  # âœ… ä½¿ç”¨æ­¥éª¤ 2 åˆ›å»ºçš„ Secret
```

---

## ğŸš€ æ­¥éª¤ 4ï¼šåˆ›å»º Jenkins æµæ°´çº¿

### 4.1 åœ¨ Jenkins ä¸­åˆ›å»º Pipeline Job

1. **ç™»å½• Jenkins**
2. **æ–°å»ºä»»åŠ¡**
   - ç‚¹å‡»"æ–°å»ºä»»åŠ¡"
   - è¾“å…¥åç§°ï¼š`nms4cloud-build`
   - é€‰æ‹©"æµæ°´çº¿ï¼ˆPipelineï¼‰"
   - ç‚¹å‡»"ç¡®å®š"

3. **é…ç½®æµæ°´çº¿**
   - å‹¾é€‰"å‚æ•°åŒ–æ„å»ºè¿‡ç¨‹"
   - æ·»åŠ å‚æ•°ï¼ˆJenkinsfile ä¸­å·²å®šä¹‰ï¼Œä¼šè‡ªåŠ¨è¯†åˆ«ï¼‰

4. **é…ç½® Pipeline è„šæœ¬**
   - Pipeline å®šä¹‰ï¼šPipeline script from SCM
   - SCMï¼šGit
   - Repository URLï¼š`https://codeup.aliyun.com/ä½ çš„ç»„ç»‡/ä½ çš„é¡¹ç›®.git`
   - Credentialsï¼šé€‰æ‹© `aliyun-codeup-token`
   - åˆ†æ”¯ï¼š`*/master`ï¼ˆæˆ–å…¶ä»–åˆ†æ”¯ï¼‰
   - Script Pathï¼š`Jenkinsfile-nms4cloud-final`ï¼ˆæˆ–ä½ çš„ Jenkinsfile è·¯å¾„ï¼‰

5. **ä¿å­˜é…ç½®**

### 4.2 æµ‹è¯•æ„å»º

1. **ç‚¹å‡»"Build with Parameters"**
2. **é€‰æ‹©å‚æ•°**ï¼š
   ```
   BUILD_MODULE: all
   GIT_BRANCH: master
   SKIP_TESTS: true
   CLEAN_BUILD: true
   BUILD_BI: true
   BUILD_WMS: true
   BUILD_DOCKER_IMAGE: true
   ```
3. **ç‚¹å‡»"å¼€å§‹æ„å»º"**

---

## âœ… éªŒè¯æµç¨‹

### 1. éªŒè¯ä»£ç æ‹‰å–

æŸ¥çœ‹æ„å»ºæ—¥å¿—ä¸­çš„"ä»£ç æ£€å‡º"é˜¶æ®µï¼š
```
=== æ£€å‡ºä¸»é¡¹ç›® ===
Cloning repository https://codeup.aliyun.com/...
âœ“ ä»£ç æ£€å‡ºå®Œæˆ
```

### 2. éªŒè¯ Maven æ„å»º

æŸ¥çœ‹æ„å»ºæ—¥å¿—ä¸­çš„"Maven æ„å»º"é˜¶æ®µï¼š
```
[1/9] å®‰è£…çˆ¶ POM
[2/9] æ„å»º nms4cloud-starter
...
âœ“ æ„å»ºå®Œæˆ
```

### 3. éªŒè¯é•œåƒæ¨é€

æŸ¥çœ‹æ„å»ºæ—¥å¿—ä¸­çš„"æ„å»ºå¹¶æ¨é€ Docker é•œåƒ"é˜¶æ®µï¼š
```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
å¼€å§‹æ„å»ºæ¨¡å—: nms4cloud-platform
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
é•œåƒåç§°: crpi-xxx.cn-hangzhou.personal.cr.aliyuncs.com/lgy-images/nms4cloud-platform
âœ“ é•œåƒæ„å»ºå¹¶æ¨é€æˆåŠŸ
```

### 4. åœ¨é˜¿é‡Œäº‘æŸ¥çœ‹é•œåƒ

1. ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
2. ä¸ªäººç‰ˆ â†’ é•œåƒä»“åº“
3. é€‰æ‹©å‘½åç©ºé—´ï¼š`lgy-images`
4. æŸ¥çœ‹æ¨é€çš„é•œåƒ

---

## ğŸ”’ æƒé™è¯´æ˜

### ä½ éœ€è¦çš„æƒé™

| èµ„æº | éœ€è¦çš„æƒé™ | è¯´æ˜ |
|------|-----------|------|
| é˜¿é‡Œäº‘æ•ˆä»£ç åº“ | **åªè¯»** | âœ… åªéœ€è¦ `read_repository` æƒé™ |
| Jenkins | **ç®¡ç†å‘˜** | éœ€è¦åˆ›å»º Job å’Œé…ç½®å‡­è¯ |
| Kubernetes é›†ç¾¤ | **ç®¡ç†å‘˜** | éœ€è¦åˆ›å»º Secret |
| é˜¿é‡Œäº‘é•œåƒä»“åº“ | **è¯»å†™** | éœ€è¦æ¨é€é•œåƒ |

### ä½ ä¸éœ€è¦çš„æƒé™

- âŒ é˜¿é‡Œäº‘æ•ˆä»£ç åº“çš„å†™å…¥æƒé™
- âŒ é˜¿é‡Œäº‘æ•ˆä»£ç åº“çš„ç®¡ç†å‘˜æƒé™
- âŒ ä¿®æ”¹åŸå§‹ä»£ç åº“çš„æƒé™

---

## ğŸ¯ å¸¸è§é—®é¢˜

### Q1: ä»£ç æ‹‰å–å¤±è´¥ï¼Œæç¤ºè®¤è¯é”™è¯¯ï¼Ÿ

**A:** æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
```bash
# 1. éªŒè¯è®¿é—®ä»¤ç‰Œæ˜¯å¦æ­£ç¡®
# åœ¨ Jenkins å‡­è¯ç®¡ç†ä¸­é‡æ–°è¾“å…¥

# 2. éªŒè¯ä»¤ç‰Œæƒé™
# ç¡®ä¿ä»¤ç‰Œæœ‰ read_repository æƒé™

# 3. éªŒè¯ä»“åº“ URL
# ç¡®ä¿ URL æ ¼å¼æ­£ç¡®ï¼šhttps://codeup.aliyun.com/ç»„ç»‡/é¡¹ç›®.git
```

### Q2: é•œåƒæ¨é€å¤±è´¥ï¼Œæç¤ºè®¤è¯é”™è¯¯ï¼Ÿ

**A:** æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
```bash
# 1. éªŒè¯ Secret æ˜¯å¦åˆ›å»ºæˆåŠŸ
kubectl get secret aliyun-recret -n jenkins

# 2. éªŒè¯ Secret å†…å®¹
kubectl get secret aliyun-registry-secret -n jenkins -o yaml

# 3. é‡æ–°åˆ›å»º Secret
kubectl delete secret aliyun-registry-secret -n jenkins
bash åˆ›å»ºé˜¿é‡Œäº‘é•œåƒä»“åº“å‡­è¯.sh
```

### Q3: å¯ä»¥åŒæ—¶æ¨é€åˆ°å¤šä¸ªé•œåƒä»“åº“å—ï¼Ÿ

**A:** å¯ä»¥ï¼ä¿®æ”¹ Jenkinsfileï¼š
```groovy
// æ¨é€åˆ°é˜¿é‡Œäº‘ä¸ªäººç‰ˆ
/kaniko/executor \
    --destination=${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/${moduleName}:${BUILD_NUMBER} \
    --destination=${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/${moduleName}:latest \
    ...

// åŒæ—¶æ¨é€åˆ°ç§æœ‰ä»“åº“
/kaniko/executor \
    --destination=192.168.80.100:30500/${moduleName}:${BUILD_NUMBER} \
    --insecure \
    ...
```

### Q4: é˜¿é‡Œäº‘ä¸ªäººç‰ˆæœ‰ä»€ä¹ˆé™åˆ¶ï¼Ÿ

**A:** ä¸ªäººç‰ˆé™åˆ¶ï¼š
- âœ… å…è´¹ä½¿ç”¨
- âœ… 300 ä¸ªé•œåƒä»“åº“
- âœ… æ— é™åˆ¶çš„é•œåƒç‰ˆæœ¬
- âš ï¸ å¸¦å®½é™åˆ¶ï¼ˆçº¦ 0.5-1 MB/sï¼‰
- âš ï¸ ä¸æ”¯æŒé•œåƒæ‰«æ
- âš ï¸ ä¸æ”¯æŒé•œåƒåŒæ­¥

**å»ºè®®ï¼š**
- ä½¿ç”¨ Level 9 å‹ç¼©ï¼ˆå·²é…ç½®ï¼‰
- å®šæœŸæ¸…ç†æ—§é•œåƒ
- è€ƒè™‘å‡çº§åˆ°ä¼ä¸šç‰ˆï¼ˆå¦‚æœéœ€è¦æ›´é«˜æ€§èƒ½ï¼‰

---

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

```
é˜¿é‡Œäº‘æ•ˆä»£ç åº“ï¼ˆåªè¯»ï¼‰
    â†“ (ä½¿ç”¨è®¿é—®ä»¤ç‰Œæ‹‰å–)
Jenkins Agent Pod
    â†“ (Maven æ„å»º)
æ„å»ºäº§ç‰©ï¼ˆJAR æ–‡ä»¶ï¼‰
    â†“ (Kaniko æ„å»ºé•œåƒ)
Docker é•œåƒ
    â†“ (æ¨é€åˆ°é˜¿é‡Œäº‘)
é˜¿é‡Œäº‘ä¸ªäººé•œåƒä»“åº“
    â†“ (Kubernetes æ‹‰å–)
åº”ç”¨ Pod
```

---

## ğŸ‰ æ€»ç»“

**ä½ çš„æ–¹æ¡ˆå®Œå…¨å¯è¡Œï¼**

âœ… **ä¼˜åŠ¿ï¼š**
1. ä¸éœ€è¦ä¿®æ”¹åŸå§‹ä»£ç åº“
2. åªéœ€è¦åªè¯»æƒé™
3. ä½¿ç”¨å…è´¹çš„é˜¿é‡Œäº‘ä¸ªäººé•œåƒä»“åº“
4. å®Œæ•´çš„ CI/CD æµç¨‹

âœ… **å·²é…ç½®ï¼š**
1. Jenkinsfile å·²ä¼˜åŒ–ï¼ˆå‹ç¼©ã€é‡è¯•ã€ç»Ÿè®¡ï¼‰
2. æ”¯æŒå¤šæ¨¡å—æ„å»º
3. è‡ªåŠ¨æ¨é€åˆ°é˜¿é‡Œäº‘é•œåƒä»“åº“
4. èµ„æºé…ç½®å·²ä¼˜åŒ–

âœ… **ä¸‹ä¸€æ­¥ï¼š**
1. åˆ›å»ºé˜¿é‡Œäº‘æ•ˆè®¿é—®ä»¤ç‰Œ
2. åˆ›å»ºé˜¿é‡Œäº‘é•œåƒä»“åº“å‡­è¯
3. åœ¨ Jenkins ä¸­åˆ›å»ºæµæ°´çº¿
4. è¿è¡Œæµ‹è¯•æ„å»º

å¼€å§‹æ„å»ºå§ï¼ğŸš€
