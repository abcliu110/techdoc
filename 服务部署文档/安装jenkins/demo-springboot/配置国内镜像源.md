# 配置国内镜像源解决 Docker Hub 访问问题

## 问题现象

```
error building image: unable to complete operation after 0 attempts, last error: 
Get "https://index.docker.io/v2/": dial tcp 173.244.217.42:443: connect: connection refused
```

**原因**：Kaniko 无法访问 Docker Hub (`index.docker.io`)，在国内环境下很常见。

## 解决方案

### 方案 1：使用国内镜像源（推荐）

修改 Dockerfile，使用国内可访问的镜像源。

#### 可用的国内镜像源

| 镜像源 | 地址格式 | 说明 |
|--------|---------|------|
| DaoCloud | `m.daocloud.io/docker.io/镜像名` | 免费，稳定，推荐 |
| 阿里云 | `registry.cn-hangzhou.aliyuncs.com/命名空间/镜像名` | 需要自己同步镜像 |
| 腾讯云 | `ccr.ccs.tencentyun.com/镜像名` | 需要账号 |
| 网易云 | `hub-mirror.c.163.com/镜像名` | 部分镜像可用 |

#### 修改 Dockerfile

**原来的 Dockerfile**：
```dockerfile
FROM eclipse-temurin:21-jre-alpine
```

**修改为（使用 DaoCloud）**：
```dockerfile
FROM m.daocloud.io/docker.io/eclipse-temurin:21-jre-alpine
```

#### 常用基础镜像的国内源

```dockerfile
# Eclipse Temurin (推荐用于 Java)
FROM m.daocloud.io/docker.io/eclipse-temurin:21-jre-alpine

# OpenJDK
FROM m.daocloud.io/docker.io/openjdk:21-jre-slim

# Alpine
FROM m.daocloud.io/docker.io/alpine:3.19

# Ubuntu
FROM m.daocloud.io/docker.io/ubuntu:22.04

# Maven
FROM m.daocloud.io/docker.io/maven:3.9-eclipse-temurin-21

# Nginx
FROM m.daocloud.io/docker.io/nginx:alpine
```

---

### 方案 2：配置 Kaniko 使用镜像代理

在 Jenkinsfile 中配置 Kaniko 使用镜像代理。

#### 修改 Jenkinsfile-k8s

在 Kaniko 容器的环境变量中添加镜像代理配置：

```groovy
containers:
- name: kaniko
  image: m.daocloud.io/gcr.io/kaniko-project/executor:debug
  env:
  - name: HTTP_PROXY
    value: "http://your-proxy:port"
  - name: HTTPS_PROXY
    value: "http://your-proxy:port"
  - name: NO_PROXY
    value: "localhost,127.0.0.1"
```

**注意**：需要有可用的代理服务器。

---

### 方案 3：在 RKE2 节点配置 Docker 镜像加速

如果你的 RKE2 集群使用 containerd，可以配置镜像加速。

#### 配置 containerd 镜像加速

在每个 RKE2 节点上编辑 `/etc/rancher/rke2/registries.yaml`：

```yaml
mirrors:
  docker.io:
    endpoint:
      - "https://m.daocloud.io/docker.io"
      - "https://docker.mirrors.ustc.edu.cn"
      - "https://hub-mirror.c.163.com"
  
  # 可选：配置其他镜像源
  gcr.io:
    endpoint:
      - "https://m.daocloud.io/gcr.io"
  
  quay.io:
    endpoint:
      - "https://m.daocloud.io/quay.io"
```

#### 重启 RKE2 服务

```bash
# 重启 RKE2
systemctl restart rke2-server  # 或 rke2-agent

# 验证配置
crictl info | grep -A 10 registry
```

**优点**：
- 全局生效，所有 Pod 都能使用
- 不需要修改 Dockerfile

**缺点**：
- 需要在每个节点配置
- 需要重启服务

---

### 方案 4：预先拉取镜像到本地

在 RKE2 节点上预先拉取镜像。

```bash
# 在每个节点上执行
crictl pull m.daocloud.io/docker.io/eclipse-temurin:21-jre-alpine

# 或者使用 kubectl
kubectl run temp-pod --image=m.daocloud.io/docker.io/eclipse-temurin:21-jre-alpine --rm -it -- sh
```

**优点**：
- 镜像已在本地，构建时不需要拉取

**缺点**：
- 需要手动维护
- 镜像更新时需要重新拉取

---

## 推荐配置（已应用）

我已经将所有 Dockerfile 修改为使用 DaoCloud 镜像源：

### 1. Dockerfile
```dockerfile
FROM m.daocloud.io/docker.io/eclipse-temurin:21-jre-alpine
```

### 2. Dockerfile.alpine-optimized
```dockerfile
FROM m.daocloud.io/docker.io/eclipse-temurin:21-jre-alpine
```

### 3. Dockerfile.layered
```dockerfile
FROM m.daocloud.io/docker.io/eclipse-temurin:21-jre-alpine AS builder
# ...
FROM m.daocloud.io/docker.io/eclipse-temurin:21-jre-alpine
```

### 4. Dockerfile.distroless
```dockerfile
# Distroless 镜像也可以使用 DaoCloud
FROM m.daocloud.io/gcr.io/distroless/java21-debian12
```

---

## 验证配置

### 1. 本地测试拉取镜像

```bash
# 测试能否拉取镜像
docker pull m.daocloud.io/docker.io/eclipse-temurin:21-jre-alpine

# 或在 RKE2 节点上
crictl pull m.daocloud.io/docker.io/eclipse-temurin:21-jre-alpine
```

### 2. 运行 Jenkins 流水线

重新运行构建，应该能够成功拉取镜像。

---

## 其他可用的镜像源

### DaoCloud 镜像源（推荐）

```
m.daocloud.io/docker.io/镜像名
m.daocloud.io/gcr.io/镜像名
m.daocloud.io/quay.io/镜像名
m.daocloud.io/k8s.gcr.io/镜像名
```

**特点**：
- ✅ 免费
- ✅ 稳定
- ✅ 支持多个上游源
- ✅ 无需注册

### 阿里云镜像服务

```
registry.cn-hangzhou.aliyuncs.com/命名空间/镜像名
```

**特点**：
- ✅ 速度快
- ⚠️ 需要自己同步镜像
- ⚠️ 需要创建命名空间和仓库

### 中科大镜像源

```
docker.mirrors.ustc.edu.cn/library/镜像名
```

**特点**：
- ✅ 教育网速度快
- ⚠️ 仅支持官方镜像

### 网易云镜像源

```
hub-mirror.c.163.com/library/镜像名
```

**特点**：
- ✅ 稳定
- ⚠️ 部分镜像可能不可用

---

## 常见问题

### 1. 镜像源拉取失败

**错误**：`error pulling image configuration: Get "https://m.daocloud.io/...": dial tcp: lookup m.daocloud.io: no such host`

**解决**：
- 检查网络连接
- 尝试其他镜像源
- 配置 DNS

### 2. 镜像不存在

**错误**：`manifest unknown: manifest unknown`

**解决**：
- 确认镜像名称正确
- 尝试使用完整路径：`m.daocloud.io/docker.io/library/镜像名`
- 检查镜像标签是否存在

### 3. 认证失败

**错误**：`unauthorized: authentication required`

**解决**：
- DaoCloud 公共镜像无需认证
- 如果使用私有镜像，需要配置 Secret

---

## 最佳实践

### 1. 统一使用国内镜像源

在所有 Dockerfile 中统一使用 DaoCloud 镜像源：

```dockerfile
FROM m.daocloud.io/docker.io/eclipse-temurin:21-jre-alpine
```

### 2. 配置 RKE2 镜像加速

在 RKE2 集群配置全局镜像加速，作为备用方案。

### 3. 缓存常用镜像

在 Jenkins agent 节点预先拉取常用镜像：

```bash
# 创建脚本 pull-common-images.sh
#!/bin/bash
images=(
  "m.daocloud.io/docker.io/eclipse-temurin:21-jre-alpine"
  "m.daocloud.io/docker.io/maven:3.9-eclipse-temurin-21"
  "m.daocloud.io/gcr.io/kaniko-project/executor:debug"
)

for image in "${images[@]}"; do
  echo "Pulling $image..."
  crictl pull "$image"
done
```

### 4. 监控镜像拉取

在 Jenkinsfile 中添加镜像拉取日志：

```groovy
sh '''
    echo ">>> 拉取基础镜像"
    crictl pull m.daocloud.io/docker.io/eclipse-temurin:21-jre-alpine
'''
```

---

## 总结

**问题**：无法访问 Docker Hub

**解决**：使用 DaoCloud 镜像源

**修改**：
```dockerfile
# 原来
FROM eclipse-temurin:21-jre-alpine

# 修改为
FROM m.daocloud.io/docker.io/eclipse-temurin:21-jre-alpine
```

**效果**：
- ✅ 镜像拉取成功
- ✅ 构建速度更快（国内网络）
- ✅ 无需额外配置

现在重新运行 Jenkins 流水线，应该可以成功构建镜像了！
