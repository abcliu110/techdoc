# 使用阿里云镜像仓库配置指南

## 一、获取阿里云镜像仓库信息

根据你的配置：
- **地域**: 华东1（杭州）
- **命名空间**: lgy-images
- **仓库名称**: lgy-test
- **仓库类型**: 公开

**完整镜像地址格式**：
```
registry.cn-hangzhou.aliyuncs.com/lgy-images/lgy-test:标签
```

## 二、设置访问凭证

### 1. 在阿里云控制台设置固定密码

1. 进入容器镜像服务控制台
2. 点击左侧菜单 "访问凭证"
3. 设置固定密码（如果还没有设置）
4. 记录下用户名和密码

**用户名格式**：通常是你的阿里云账号或 RAM 用户名

## 三、在 Kubernetes 中创建 Secret

### 方式一：使用 kubectl 命令创建

```bash
kubectl create secret docker-registry aliyun-registry-secret \
  --docker-server=registry.cn-hangzhou.aliyuncs.com \
  --docker-username=你的阿里云账号 \
  --docker-password=你的镜像仓库密码 \
  --docker-email=你的邮箱 \
  -n default
```

### 方式二：使用 YAML 文件创建

创建 `aliyun-registry-secret.yaml`：

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: aliyun-registry-secret
  namespace: default
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: <base64编码的认证信息>
```

生成 base64 编码的认证信息：

```bash
# 先创建 config.json
cat > config.json <<EOF
{
  "auths": {
    "registry.cn-hangzhou.aliyuncs.com": {
      "username": "你的用户名",
      "password": "你的密码",
      "auth": "$(echo -n '你的用户名:你的密码' | base64)"
    }
  }
}
EOF

# 然后 base64 编码
cat config.json | base64 -w 0
```

应用 Secret：
```bash
kubectl apply -f aliyun-registry-secret.yaml
```

## 四、修改 Jenkinsfile 配置

### 1. 修改 Kubernetes Pod 定义

在 Jenkinsfile 中修改 Pod 定义，添加 imagePullSecrets：

```groovy
pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins: agent
    project: nms4cloud
spec:
  # 添加镜像拉取凭证（如果需要从阿里云拉取基础镜像）
  imagePullSecrets:
  - name: aliyun-registry-secret
  
  containers:
  - name: maven
    image: maven:3.9-eclipse-temurin-21
    command:
    - cat
    tty: true
    volumeMounts:
    - name: jenkins-home
      mountPath: /var/jenkins_home
    # 挂载 Docker 认证配置
    - name: docker-config
      mountPath: /kaniko/.docker
    resources:
      requests:
        cpu: 1000m
        memory: 3Gi
      limits:
        cpu: 4000m
        memory: 6Gi
        
  - name: kaniko
    image: m.daocloud.io/gcr.io/kaniko-project/executor:debug
    command:
    - /busybox/cat
    tty: true
    volumeMounts:
    - name: jenkins-home
      mountPath: /var/jenkins_home
    # 挂载 Docker 认证配置
    - name: docker-config
      mountPath: /kaniko/.docker
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 2000m
        memory: 2Gi
        
  volumes:
  - name: jenkins-home
    persistentVolumeClaim:
      claimName: jenkins-pvc
  # 添加 Docker 认证配置卷
  - name: docker-config
    secret:
      secretName: aliyun-registry-secret
      items:
      - key: .dockerconfigjson
        path: config.json
"""
        }
    }
```

### 2. 修改环境变量

```groovy
environment {
    // ... 其他配置 ...
    
    // 阿里云镜像仓库配置
    DOCKER_REGISTRY = 'registry.cn-hangzhou.aliyuncs.com/lgy-images'
    DOCKER_IMAGE_TAG = "${env.BUILD_NUMBER}"
}
```

### 3. 修改 Kaniko 构建命令

在 `buildModuleImage` 函数中，移除 `--insecure` 和 `--skip-tls-verify` 参数（阿里云使用 HTTPS）：

```groovy
# 使用 Kaniko 构建并推送镜像
/kaniko/executor \\
    --context=${buildContext} \\
    --dockerfile=${dockerfilePath} \\
    --destination=${dockerImageName}:${DOCKER_IMAGE_TAG} \\
    --destination=${dockerImageName}:latest \\
    --cache=false \\
    --verbosity=info
```

## 五、测试推送

### 1. 手动测试（可选）

在本地测试推送到阿里云：

```bash
# 登录阿里云镜像仓库
docker login --username=你的用户名 registry.cn-hangzhou.aliyuncs.com

# 构建测试镜像
docker build -t registry.cn-hangzhou.aliyuncs.com/lgy-images/lgy-test:v1 .

# 推送镜像
docker push registry.cn-hangzhou.aliyuncs.com/lgy-images/lgy-test:v1
```

### 2. 在 Jenkins 中运行流水线

1. 提交修改后的 Jenkinsfile
2. 在 Jenkins 中运行构建
3. 勾选 `BUILD_DOCKER_IMAGE` 参数
4. 查看构建日志，确认镜像推送成功

## 六、在 K8s 中使用阿里云镜像

### 1. 创建 Deployment 使用镜像

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nms4cloud-platform
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nms4cloud-platform
  template:
    metadata:
      labels:
        app: nms4cloud-platform
    spec:
      # 如果是私有仓库，需要添加 imagePullSecrets
      # imagePullSecrets:
      # - name: aliyun-registry-secret
      
      containers:
      - name: nms4cloud-platform
        image: registry.cn-hangzhou.aliyuncs.com/lgy-images/nms4cloud-platform:1
        ports:
        - containerPort: 8080
```

### 2. 应用部署

```bash
kubectl apply -f deployment.yaml
```

## 七、常见问题

### 1. 推送失败：unauthorized

**原因**：认证信息不正确

**解决**：
- 检查用户名和密码是否正确
- 确认 Secret 是否创建成功：`kubectl get secret aliyun-registry-secret -n default`
- 查看 Secret 内容：`kubectl get secret aliyun-registry-secret -o yaml`

### 2. 推送失败：repository does not exist

**原因**：仓库不存在或命名空间错误

**解决**：
- 确认命名空间和仓库名称正确
- 在阿里云控制台检查仓库是否存在
- 如果是公开仓库，首次推送会自动创建

### 3. Kaniko 找不到认证配置

**原因**：Docker config 没有正确挂载

**解决**：
- 检查 Pod 定义中的 volumes 和 volumeMounts 配置
- 确认 Secret 挂载路径为 `/kaniko/.docker/config.json`

### 4. 公开仓库 vs 私有仓库

- **公开仓库**：推送需要认证，拉取不需要认证
- **私有仓库**：推送和拉取都需要认证

如果你的仓库是公开的，K8s 拉取镜像时不需要 imagePullSecrets。

## 八、完整示例

### Jenkinsfile 环境变量部分

```groovy
environment {
    // Maven 配置
    MAVEN_LOCAL_REPO = '/var/jenkins_home/maven-repository'
    MAVEN_OPTS = '-Xmx3072m -XX:+UseG1GC -XX:MaxMetaspaceSize=512m'
    MAVEN_BASE_OPTS = "-Dmaven.repo.local=${MAVEN_LOCAL_REPO} -Dmaven.compile.fork=true"

    // 项目配置
    PROJECT_NAME = 'nms4cloud'
    ARTIFACT_VERSION = '0.0.1-SNAPSHOT'

    // Git 配置
    GIT_CREDENTIAL_ID = 'aliyun-codeup-token'
    GIT_BRANCH = "${params.GIT_BRANCH ?: 'master'}"

    // 阿里云镜像仓库配置
    DOCKER_REGISTRY = 'registry.cn-hangzhou.aliyuncs.com/lgy-images'
    DOCKER_IMAGE_TAG = "${env.BUILD_NUMBER}"
}
```

### 镜像命名示例

构建后的镜像名称：
```
registry.cn-hangzhou.aliyuncs.com/lgy-images/nms4cloud-platform:1
registry.cn-hangzhou.aliyuncs.com/lgy-images/nms4cloud-platform:latest
registry.cn-hangzhou.aliyuncs.com/lgy-images/nms4cloud-product:1
registry.cn-hangzhou.aliyuncs.com/lgy-images/nms4cloud-product:latest
...
```
