# 问题修复：JAR 文件缺失和 RKE2 HTTP 仓库配置

## 问题现象

1. **应用启动失败**：`Error: Unable to access jarfile /app/app.jar`
2. **RKE2 使用 HTTPS**：containerd 配置显示 `server = "https://192.168.80.100:30500"` 而不是 `http://`

## 根本原因

### 问题 1：`.dockerignore` 排除了 JAR 文件

`.dockerignore` 文件的第一行是 `target/`，导致 Kaniko 构建镜像时无法复制 JAR 文件：

```
# Maven
target/          ← 这一行导致 target 目录被排除
pom.xml.tag
...
```

虽然 Jenkins 日志显示 JAR 文件存在：
```
/home/jenkins/agent/workspace/测试项目/target/demo-springboot.jar
```

但 Kaniko 在构建时会忽略 `target/` 目录，导致 `COPY target/*.jar app.jar` 命令失败（静默失败）。

### 问题 2：RKE2 配置缺少私有仓库

`rke2-registries.yaml` 只配置了公共镜像加速，没有配置私有仓库 `192.168.80.100:30500`。

RKE2 默认对所有仓库使用 HTTPS，除非在 `mirrors` 和 `configs` 中明确指定使用 HTTP。

## 解决方案

### 修复 1：删除 `.dockerignore` 文件

**已执行**：删除了 `服务部署文档/安装jenkins/demo-springboot/.dockerignore` 文件

这样 Kaniko 就能访问 `target/` 目录并复制 JAR 文件到镜像中。

### 修复 2：更新 RKE2 配置

**已更新**：`服务部署文档/安装jenkins/rke2-registries.yaml` 现在包含：

```yaml
mirrors:
  # 私有 Docker Registry（HTTP 协议）
  "192.168.80.100:30500":
    endpoint:
      - "http://192.168.80.100:30500"    # 明确使用 HTTP
  
  # ... 其他镜像加速配置 ...

# 私有仓库配置（跳过 TLS 验证）
configs:
  "192.168.80.100:30500":
    tls:
      insecure_skip_verify: true
```

## 执行步骤

### 步骤 1：更新 RKE2 配置

在 RKE2 节点上执行：

```bash
# 1. 备份现有配置
sudo cp /etc/rancher/rke2/registries.yaml /etc/rancher/rke2/registries.yaml.backup

# 2. 更新配置文件（复制新的 rke2-registries.yaml 内容）
sudo nano /etc/rancher/rke2/registries.yaml
```

粘贴更新后的配置内容，确保包含：
- `mirrors` 部分的 `"192.168.80.100:30500"` 配置
- `configs` 部分的 `insecure_skip_verify: true` 配置

```bash
# 3. 重启 RKE2
sudo systemctl restart rke2-server

# 4. 等待服务启动
sleep 30

# 5. 验证配置生成
cat /var/lib/rancher/rke2/agent/etc/containerd/certs.d/192.168.80.100:30500/hosts.toml
```

**期望输出**：
```toml
# File generated by rke2. DO NOT EDIT.
server = "http://192.168.80.100:30500/v2"    ← 注意是 http:// 不是 https://
capabilities = ["pull", "resolve", "push"]
skip_verify = true
```

```bash
# 6. 测试拉取镜像
/var/lib/rancher/rke2/bin/crictl pull 192.168.80.100:30500/demo-springboot:latest
```

**期望结果**：成功拉取镜像，不再报 "http: server gave HTTP response to HTTPS client" 错误

### 步骤 2：重新构建 Docker 镜像

在 Jenkins 中重新运行构建：

1. 打开 Jenkins 项目
2. 点击 "Build with Parameters"
3. 确保 `BUILD_DOCKER_IMAGE` 勾选
4. 点击 "Build"

**关键验证点**：

Jenkins 日志中应该看到：
```
>>> 检查 .dockerignore 文件
未找到 .dockerignore 文件    ← 确认文件已删除
```

Kaniko 构建日志应该显示成功复制 JAR 文件（不会再有 404 错误）。

### 步骤 3：验证镜像内容

构建完成后，验证新镜像包含 JAR 文件：

```bash
# 运行临时容器检查文件
kubectl run test-verify \
  --image=192.168.80.100:30500/demo-springboot:latest \
  --restart=Never \
  --command -- ls -la /app/

# 等待几秒
sleep 5

# 查看日志
kubectl logs test-verify

# 清理
kubectl delete pod test-verify
```

**期望输出**：
```
total 40000
drwxr-xr-x    1 appuser  appuser       4096 Feb 15 12:30 .
drwxr-xr-x    1 root     root          4096 Feb 15 12:30 ..
-rw-r--r--    1 appuser  appuser   40000000 Feb 15 12:30 app.jar    ← JAR 文件存在
```

### 步骤 4：部署应用

如果镜像验证通过，部署应用：

```bash
# 方式 1：更新现有 Deployment
kubectl set image deployment/demo-springboot \
  demo-springboot=192.168.80.100:30500/demo-springboot:latest

# 方式 2：删除并重新创建 Pod
kubectl delete pod -l app=demo-springboot

# 查看 Pod 状态
kubectl get pods -w
```

**期望结果**：Pod 状态变为 `Running`，不再是 `CrashLoopBackOff`

### 步骤 5：验证应用运行

```bash
# 查看应用日志
kubectl logs -f deployment/demo-springboot

# 测试健康检查
kubectl exec -it deployment/demo-springboot -- wget -O- http://localhost:8080/actuator/health

# 测试 API
kubectl exec -it deployment/demo-springboot -- wget -O- http://localhost:8080/api/hello
```

## 技术细节

### 为什么 `.dockerignore` 会导致问题？

`.dockerignore` 的工作原理类似 `.gitignore`，它告诉 Docker/Kaniko 在构建上下文中忽略哪些文件。

当 Dockerfile 中有 `COPY target/*.jar app.jar` 时：
- 如果 `.dockerignore` 包含 `target/`，Kaniko 会忽略整个 target 目录
- `COPY` 命令找不到任何匹配的文件，但不会报错（这是 Docker 的设计）
- 最终镜像中 `/app/app.jar` 不存在
- 应用启动时报错：`Error: Unable to access jarfile /app/app.jar`

### 为什么需要在 RKE2 中配置 mirrors？

RKE2 使用 containerd 作为容器运行时，containerd 的配置逻辑是：

1. 检查 `/etc/rancher/rke2/registries.yaml` 中的 `mirrors` 配置
2. 如果找到匹配的仓库，使用 `endpoint` 中指定的 URL
3. 如果没有配置，默认使用 `https://<registry-address>`

对于私有 HTTP 仓库，必须在 `mirrors` 中明确指定 `http://` 协议，否则 containerd 会尝试 HTTPS 连接并失败。

### Kaniko 的 `--cache=false` 参数

Jenkinsfile 中使用了 `--cache=false`，这是因为：
- Kaniko 默认会缓存镜像层
- 如果 JAR 文件更新但 Dockerfile 没变，Kaniko 可能使用旧的缓存层
- `--cache=false` 强制重新构建所有层，确保使用最新的 JAR 文件

## 常见问题

### Q1：删除 `.dockerignore` 会有什么影响？

A：`.dockerignore` 的主要作用是减小构建上下文大小，加快构建速度。删除后：
- 构建上下文会包含更多文件（如 `.git/`、`.idea/` 等）
- 构建时间可能稍微增加（通常影响很小）
- 但不会影响最终镜像大小（因为 Dockerfile 只 COPY 了 JAR 文件）

如果需要保留 `.dockerignore`，可以只删除 `target/` 这一行，保留其他排除规则。

### Q2：为什么不在 Dockerfile 中使用多阶段构建？

A：当前方案中，Maven 构建和 Docker 构建是分离的：
- Maven 在 Jenkins Pod 的 maven 容器中构建
- Kaniko 在同一个 Pod 的 kaniko 容器中构建镜像
- 两个容器共享 PVC，可以访问同一个 workspace

这种方式的优点：
- Maven 可以使用持久化的依赖缓存（`/var/jenkins_home/maven-repository`）
- 与其他项目（如 nms4cloud）共享 Maven 仓库
- 构建速度更快

如果使用多阶段构建，每次都需要重新下载 Maven 依赖。

### Q3：RKE2 配置更新后需要重启所有节点吗？

A：
- 单节点集群：只需重启 `rke2-server`
- 多节点集群：
  - Master 节点：`sudo systemctl restart rke2-server`
  - Worker 节点：`sudo systemctl restart rke2-agent`

建议逐个节点重启，避免服务中断。

## 总结

两个关键修复：
1. **删除 `.dockerignore`**：让 Kaniko 能够访问 `target/` 目录中的 JAR 文件
2. **更新 RKE2 配置**：在 `mirrors` 和 `configs` 中添加私有仓库配置，使用 HTTP 协议

完成这两个修复后，应用应该能够正常构建、推送和部署。
