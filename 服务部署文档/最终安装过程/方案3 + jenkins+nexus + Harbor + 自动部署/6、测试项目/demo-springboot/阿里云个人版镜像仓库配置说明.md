# 阿里云个人版镜像仓库配置说明

## 重要提示

阿里云个人版镜像仓库与企业版不同，必须使用专属域名，不能使用通用域名。

## 一、个人版 vs 企业版的区别

### 企业版（通用域名）
```
registry.cn-hangzhou.aliyuncs.com
```

### 个人版（专属域名）
```
crpi-xxxxxx.cn-hangzhou.personal.cr.aliyuncs.com
```

每个账号的专属域名都不同，必须从阿里云控制台获取。

## 二、获取专属域名

### 1. 登录阿里云容器镜像服务控制台

访问：https://cr.console.aliyun.com/

### 2. 查看专属域名

1. 点击左侧菜单 **"默认实例"** 或 **"个人实例"**
2. 点击 **"仓库管理"** → **"镜像仓库"**
3. 选择你的命名空间（如 `lgy-images`）
4. 点击任意仓库名称
5. 在仓库详情页面，可以看到：
   - **公网地址**：`crpi-xxxxxx.cn-hangzhou.personal.cr.aliyuncs.com/命名空间/仓库名`
   - **专有网络**：`crpi-xxxxxx-vpc.cn-hangzhou.personal.cr.aliyuncs.com/命名空间/仓库名`

### 3. 记录信息

根据实际配置记录：
- **专属域名**：`crpi-csgbt2t7j15cj178.cn-hangzhou.personal.cr.aliyuncs.com`
- **命名空间**：`lgy-images`
- **仓库名**：`lgy-test-repository`
- **用户名**：`abcliu110`
- **密码**：`st11338st11338`

## 三、创建 Kubernetes Secret

### 关键点：Secret 必须包含 auth 字段

阿里云个人版镜像仓库的 Secret 必须包含 `auth` 字段（base64 编码的 `username:password`），不能只有 `username` 和 `password` 字段。

### 正确的 Secret 格式

创建 `aliyun-registry-secret.yaml`：

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: aliyun-registry-secret
  namespace: jenkins  # 注意：必须与 Jenkins 运行的命名空间一致
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: eyJhdXRocyI6eyJjcnBpLWNzZ2J0MnQ3ajE1Y2oxNzguY24taGFuZ3pob3UucGVyc29uYWwuY3IuYWxpeXVuY3MuY29tIjp7ImF1dGgiOiJZV0pqYkdsMU1URXdPbk4wTVRFek16aHpkREV4TXpNNCJ9fX0=
```

### 生成 Secret 内容

如果需要修改用户名或密码，按以下步骤生成新的 Secret：

```bash
# 1. 生成 auth 字段（base64 编码的 username:password）
echo -n 'abcliu110:st11338st11338' | base64
# 输出：YWJjbGl1MTEwOnN0MTEzMzhzdDExMzM4

# 2. 创建 config.json
cat > config.json <<EOF
{
  "auths": {
    "crpi-csgbt2t7j15cj178.cn-hangzhou.personal.cr.aliyuncs.com": {
      "auth": "YWJjbGl1MTEwOnN0MTEzMzhzdDExMzM4"
    }
  }
}
EOF

# 3. 生成 .dockerconfigjson 字段（base64 编码整个 config.json）
cat config.json | base64 -w 0
# 输出：eyJhdXRocyI6eyJjcnBpLWNzZ2J0MnQ3ajE1Y2oxNzguY24taGFuZ3pob3UucGVyc29uYWwuY3IuYWxpeXVuY3MuY29tIjp7ImF1dGgiOiJZV0pqYkdsMU1URXdPbk4wTVRFek16aHpkREV4TXpNNCJ9fX0=
```

### 应用 Secret

```bash
# 应用 Secret
kubectl apply -f aliyun-registry-secret.yaml

# 验证 Secret
kubectl get secret aliyun-registry-secret -n jenkins

# 查看 Secret 内容
kubectl get secret aliyun-registry-secret -n jenkins -o jsonpath='{.data.\.dockerconfigjson}' | base64 -d
```

## 四、Jenkinsfile 配置

### 1. 环境变量配置

```groovy
environment {
    // 阿里云镜像仓库配置（个人版公网地址）
    DOCKER_REGISTRY = 'crpi-csgbt2t7j15cj178.cn-hangzhou.personal.cr.aliyuncs.com'
    DOCKER_NAMESPACE = 'lgy-images'
    DOCKER_REPOSITORY_NAME = 'lgy-test-repository'
    DOCKER_IMAGE_NAME = "${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/${DOCKER_REPOSITORY_NAME}"
    DOCKER_IMAGE_TAG = "${env.BUILD_NUMBER}"
}
```

### 2. Kubernetes Pod 配置

```groovy
agent {
    kubernetes {
        yaml """
apiVersion: v1
kind: Pod
spec:
  imagePullSecrets:
  - name: aliyun-registry-secret
  
  containers:
  - name: kaniko
    image: m.daocloud.io/gcr.io/kaniko-project/executor:debug
    volumeMounts:
    - name: docker-config
      mountPath: /kaniko/.docker
      
  volumes:
  - name: docker-config
    secret:
      secretName: aliyun-registry-secret
      items:
      - key: .dockerconfigjson
        path: config.json
"""
    }
}
```

## 五、常见错误及解决方案

### 错误 1：DENIED: requested access to the resource is denied

**原因**：使用了错误的域名（通用域名而不是专属域名）

**错误示例**：
```
registry.cn-hangzhou.aliyuncs.com/lgy-images/lgy-test-repository
```

**正确示例**：
```
crpi-csgbt2t7j15cj178.cn-hangzhou.personal.cr.aliyuncs.com/lgy-images/lgy-test-repository
```

### 错误 2：Secret 格式不正确

**原因**：Secret 只包含 `username` 和 `password` 字段，缺少 `auth` 字段

**错误的 config.json**：
```json
{
  "auths": {
    "crpi-xxx.cn-hangzhou.personal.cr.aliyuncs.com": {
      "username": "abcliu110",
      "password": "st11338st11338"
    }
  }
}
```

**正确的 config.json**：
```json
{
  "auths": {
    "crpi-xxx.cn-hangzhou.personal.cr.aliyuncs.com": {
      "auth": "YWJjbGl1MTEwOnN0MTEzMzhzdDExMzM4"
    }
  }
}
```

### 错误 3：命名空间不匹配

**原因**：Secret 在 `default` 命名空间，但 Jenkins 运行在 `jenkins` 命名空间

**解决**：
```bash
# 删除错误命名空间的 Secret
kubectl delete secret aliyun-registry-secret -n default

# 在正确的命名空间创建 Secret
kubectl apply -f aliyun-registry-secret.yaml
```

## 六、验证配置

### 1. 检查 Secret

```bash
# 查看 Secret
kubectl get secret aliyun-registry-secret -n jenkins

# 解码查看内容
kubectl get secret aliyun-registry-secret -n jenkins -o jsonpath='{.data.\.dockerconfigjson}' | base64 -d
```

输出应该类似：
```json
{"auths":{"crpi-csgbt2t7j15cj178.cn-hangzhou.personal.cr.aliyuncs.com":{"auth":"YWJjbGl1MTEwOnN0MTEzMzhzdDExMzM4"}}}
```

### 2. 运行 Jenkins 流水线

1. 勾选 `BUILD_DOCKER_IMAGE` 参数
2. 运行构建
3. 查看日志，确认镜像推送成功

### 3. 在阿里云控制台验证

1. 登录阿里云容器镜像服务控制台
2. 进入 **仓库管理** → **镜像仓库**
3. 选择命名空间 `lgy-images`
4. 点击仓库 `lgy-test-repository`
5. 查看 **镜像版本**，确认新镜像已上传

## 七、完整配置清单

### 1. 阿里云信息
- 专属域名：`crpi-csgbt2t7j15cj178.cn-hangzhou.personal.cr.aliyuncs.com`
- 命名空间：`lgy-images`
- 仓库名：`lgy-test-repository`
- 用户名：`abcliu110`
- 密码：`st11338st11338`

### 2. Kubernetes Secret
- 名称：`aliyun-registry-secret`
- 命名空间：`jenkins`
- 类型：`kubernetes.io/dockerconfigjson`
- 必须包含 `auth` 字段

### 3. Jenkinsfile 配置
- 使用专属域名
- 分开定义命名空间和仓库名
- 挂载 Secret 到 `/kaniko/.docker/config.json`

## 八、总结

配置阿里云个人版镜像仓库的关键点：

1. **必须使用专属域名**，不能使用通用域名
2. **Secret 必须包含 auth 字段**，格式为 base64(username:password)
3. **命名空间必须匹配**，Secret 和 Jenkins 在同一命名空间
4. **分开定义项目名和仓库名**，不要混用变量

按照以上配置，即可成功推送镜像到阿里云个人版镜像仓库。
