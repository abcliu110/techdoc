/*
 * ============================================================================
 * Demo Spring Boot CI/CD æµæ°´çº¿ (è‡ªåŠ¨æ„å»º + è‡ªåŠ¨éƒ¨ç½²)
 * ============================================================================
 */
pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins: agent
    app: demo-springboot-cicd
spec:
  # æ³¨æ„ï¼šæ­¤ ServiceAccount å¿…é¡»æœ‰ K8s çš„éƒ¨ç½²æƒé™
  serviceAccountName: default
  containers:
  # 1. Maven æ„å»ºç¯å¢ƒ
  - name: maven
    image: maven:3.9-eclipse-temurin-21
    command: ["cat"]
    tty: true
    volumeMounts:
    - name: jenkins-home
      mountPath: /var/jenkins_home
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 2000m
        memory: 2Gi

  # 2. Kaniko é•œåƒæ„å»ºç¯å¢ƒ
  - name: kaniko
    image: m.daocloud.io/gcr.io/kaniko-project/executor:debug
    command: ["/busybox/cat"]
    tty: true
    volumeMounts:
    - name: jenkins-home
      mountPath: /var/jenkins_home
    resources:
      requests:
        cpu: 500m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1Gi

  # 3. Kubectl éƒ¨ç½²å·¥å…·
  - name: kubectl
    image: bitnami/kubectl:latest
    command: ["cat"]
    tty: true
    # ğŸ‘‡ã€ä¿®å¤ç‚¹ã€‘: å¼ºåˆ¶ä»¥ root (UID 0) èº«ä»½è¿è¡Œï¼Œè§£å†³ Jenkins è„šæœ¬æ— æƒé™å†™å…¥å¯¼è‡´æ²¡æ³•å¯åŠ¨è¿›ç¨‹çš„æŠ¥é”™
    securityContext:
      runAsUser: 0
    resources:
      limits:
        cpu: 500m
        memory: 256Mi

  volumes:
  - name: jenkins-home
    persistentVolumeClaim:
      claimName: jenkins-pvc
"""
        }
    }

    environment {
        // ========== å…¨å±€é…ç½® ==========
        // é¡¹ç›®åŸºç¡€ä¿¡æ¯
        APP_NAME = "demo-springboot"
        APP_PORT = "8080"
        DEPLOY_NAMESPACE = "default" // éƒ¨ç½²åˆ°å“ªä¸ª K8s å‘½åç©ºé—´
        
        // ä»“åº“é…ç½®
        GIT_URL = 'https://codeup.aliyun.com/613895a803e1c17d57a7630f/mytest.git'
        GIT_CRED_ID = 'aliyun-codeup-token'
        
        // Nexus é…ç½®
        NEXUS_URL = 'http://nexus.nexus:8081'
        NEXUS_CRED_ID = 'nexus-credentials'
        
        // Harbor é…ç½® (å¼ºåˆ¶ä½¿ç”¨å†…éƒ¨åŸŸå harbor.harbor)
        HARBOR_HOST = "harbor.harbor"  
        HARBOR_PROJECT = "library"
        HARBOR_CRED_ID = "harbor-user-auth"
    }

    stages {
        // ========== é˜¶æ®µ 1: æ‹‰å–ä»£ç  ==========
        stage('ä»£ç æ£€å‡º') {
            steps {
                container('maven') {
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: "*/master"]],
                        extensions: [[$class: 'CloneOption', depth: 1, shallow: true, timeout: 20]],
                        userRemoteConfigs: [[credentialsId: "${GIT_CRED_ID}", url: "${GIT_URL}"]]
                    ])
                }
            }
        }

        // ========== é˜¶æ®µ 2: ç¼–è¯‘æ‰“åŒ… ==========
        stage('Maven æ„å»º') {
            steps {
                container('maven') {
                    script {
                        def settingsPath = "/tmp/settings.xml"
                        // åŠ¨æ€ç”Ÿæˆ Maven é…ç½®
                        sh """
                            echo '<settings><mirrors><mirror><id>nexus</id><mirrorOf>*</mirrorOf><url>${NEXUS_URL}/repository/maven-public/</url></mirror></mirrors><servers><server><id>nexus-releases</id><username>\${NEXUS_USER}</username><password>\${NEXUS_PASS}</password></server><server><id>nexus-snapshots</id><username>\${NEXUS_USER}</username><password>\${NEXUS_PASS}</password></server></servers></settings>' > ${settingsPath}
                        """
                        withCredentials([usernamePassword(credentialsId: "${NEXUS_CRED_ID}", usernameVariable: 'NEXUS_USER', passwordVariable: 'NEXUS_PASS')]) {
                            sh "mvn clean package -B -DskipTests -s ${settingsPath}"
                        }
                    }
                }
            }
        }

        // ========== é˜¶æ®µ 3: æ„å»ºå¹¶æ¨é€é•œåƒ ==========
        stage('é•œåƒæ„å»ºæ¨é€') {
            steps {
                container('kaniko') {
                    withCredentials([usernamePassword(credentialsId: "${HARBOR_CRED_ID}", usernameVariable: 'HB_USER', passwordVariable: 'HB_PASS')]) {
                        script {
                            // è®¡ç®—é•œåƒå…¨å: harbor.harbor/library/demo-springboot
                            def fullImageName = "${HARBOR_HOST}/${HARBOR_PROJECT}/${APP_NAME}"
                            
                            echo ">>> ç”Ÿæˆè®¤è¯ä¿¡æ¯ (Target: ${HARBOR_HOST})..."
                            // ğŸ‘‡ã€ä¼˜åŒ–ç‚¹ã€‘: å¢åŠ äº†å¯¹å˜é‡çš„ \ è½¬ä¹‰ï¼Œé¿å…æ˜æ–‡å‡­æ®æ³¨å…¥ Groovy å­—ç¬¦ä¸²å¼•å‘ Jenkins å®‰å…¨å‘Šè­¦
                            sh """
                                mkdir -p /kaniko/.docker
                                AUTH=\$(echo -n "\${HB_USER}:\${HB_PASS}" | base64)
                                echo "{\\"auths\\":{\\"${HARBOR_HOST}\\":{\\"auth\\":\\"\$AUTH\\"}}}" > /kaniko/.docker/config.json
                            """

                            if (!fileExists('Dockerfile')) { error "âŒ æœªæ‰¾åˆ° Dockerfile" }

                            echo ">>> æ„å»ºé•œåƒ: ${fullImageName}:${BUILD_NUMBER}"
                            sh """
                                /kaniko/executor \
                                    --context=${WORKSPACE} \
                                    --dockerfile=${WORKSPACE}/Dockerfile \
                                    --destination=${fullImageName}:${BUILD_NUMBER} \
                                    --destination=${fullImageName}:latest \
                                    --insecure \
                                    --insecure-pull \
                                    --skip-tls-verify \
                                    --insecure-registry=${HARBOR_HOST} \
                                    --registry-mirror=${HARBOR_HOST}/dockerhub-proxy \
                                    --cache=false \
                                    --verbosity=info
                            """
                        }
                    }
                }
            }
        }

        // ========== é˜¶æ®µ 4: éƒ¨ç½²åˆ° K8s (è‡ªåŠ¨ç”Ÿæˆ YAML) ==========
        stage('è‡ªåŠ¨éƒ¨ç½²åˆ°é›†ç¾¤') {
            steps {
                container('kubectl') {
                    script {
                        echo ">>> å¼€å§‹éƒ¨ç½²åº”ç”¨åˆ° Namespace: ${DEPLOY_NAMESPACE}"

                        def fullImageName = "${HARBOR_HOST}/${HARBOR_PROJECT}/${APP_NAME}"
                        def imageTag = "${fullImageName}:${BUILD_NUMBER}"

                        // åˆ›å»º Harbor è®¤è¯ Secretï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                        echo ">>> é…ç½® Harbor é•œåƒæ‹‰å–è®¤è¯..."
                        withCredentials([usernamePassword(credentialsId: "${HARBOR_CRED_ID}", usernameVariable: 'HB_USER', passwordVariable: 'HB_PASS')]) {
                            sh """
                                kubectl get secret harbor-registry-secret -n ${DEPLOY_NAMESPACE} 2>/dev/null || \
                                kubectl create secret docker-registry harbor-registry-secret \
                                    --docker-server=${HARBOR_HOST} \
                                    --docker-username=\${HB_USER} \
                                    --docker-password=\${HB_PASS} \
                                    -n ${DEPLOY_NAMESPACE}
                            """
                        }

                        // ç”Ÿæˆ Deployment YAMLï¼ˆåŒ…å« imagePullSecretsï¼‰
                        sh """ cat <<EOF > deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${APP_NAME}
  namespace: ${DEPLOY_NAMESPACE}
  labels:
    app: ${APP_NAME}
spec:
  replicas: 1
  revisionHistoryLimit: 5
  selector:
    matchLabels:
      app: ${APP_NAME}
  template:
    metadata:
      labels:
        app: ${APP_NAME}
    spec:
      imagePullSecrets:
      - name: harbor-registry-secret
      containers:
      - name: ${APP_NAME}
        image: ${imageTag}
        imagePullPolicy: Always
        ports:
        - containerPort: ${APP_PORT}
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1024Mi
---
apiVersion: v1
kind: Service
metadata:
  name: ${APP_NAME}-svc
  namespace: ${DEPLOY_NAMESPACE}
spec:
  type: NodePort
  selector:
    app: ${APP_NAME}
  ports:
  - port: ${APP_PORT}
    targetPort: ${APP_PORT}
    nodePort: 30090
EOF
                        """

                        echo ">>> åº”ç”¨ YAML é…ç½®..."
                        sh "kubectl apply -f deployment.yaml"

                        echo ">>> æ£€æŸ¥æ»šåŠ¨æ›´æ–°çŠ¶æ€..."
                        // ç­‰å¾… Deployment æ›´æ–°å®Œæˆï¼Œè¶…æ—¶æ—¶é—´ 2 åˆ†é’Ÿ
                        sh "kubectl rollout status deployment/${APP_NAME} -n ${DEPLOY_NAMESPACE} --timeout=120s"

                        echo ">>> è·å– Pod çŠ¶æ€..."
                        sh "kubectl get pods -n ${DEPLOY_NAMESPACE} -l app=${APP_NAME}"
                    }
                }
            }
        }
    }
}