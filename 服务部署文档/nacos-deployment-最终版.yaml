---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nacos
  namespace: nms4cloud
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nacos
  template:
    metadata:
      labels:
        app: nacos
    spec:
      # ========================================
      # 1. 初始化容器：使用 MySQL 8.0 深度校验
      # ========================================
      initContainers:
        - name: wait-for-mysql
          image: mysql:8.0
          env:
            - name: MYSQL_PWD
              value: "st11338"
          command:
            - sh
            - -c
            - |
              echo "等待 MySQL 完全就绪..."
              until mysql -h mysql -P 3306 -u root -e "SELECT 1" > /dev/null 2>&1; do
                echo "MySQL 尚未就绪，等待 5 秒后重试..."
                sleep 5
              done
              echo "MySQL 已完全就绪"

              echo "验证 nacos 数据库是否存在..."
              until mysql -h mysql -P 3306 -u root -e "USE nacos; SELECT count(*) FROM config_info;" > /dev/null 2>&1; do
                echo "警告: nacos 数据库不存在或表结构未初始化，请执行 SQL 脚本！"
                echo "等待 10 秒后重试..."
                sleep 10
              done
              echo "nacos 数据库验证成功"

      # ========================================
      # 2. Nacos 主容器
      # ========================================
      containers:
        - name: nacos
          image: nacos/nacos-server:v2.2.0
          imagePullPolicy: IfNotPresent

          ports:
            - containerPort: 8848
              hostPort: 8848
              name: client
            - containerPort: 9848
              hostPort: 9848
              name: client-rpc
            - containerPort: 9849
              hostPort: 9849
              name: raft-rpc
            - containerPort: 7848
              hostPort: 7848
              name: old-raft-rpc

          env:
            - name: MODE
              value: "standalone"
            - name: PREFER_HOST_MODE
              value: "hostname"

            # MySQL 数据源配置
            - name: SPRING_DATASOURCE_PLATFORM
              value: "mysql"
            - name: MYSQL_SERVICE_HOST
              value: "mysql"
            - name: MYSQL_SERVICE_PORT
              value: "3306"
            - name: MYSQL_SERVICE_DB_NAME
              value: "nacos"
            - name: MYSQL_SERVICE_USER
              value: "root"
            - name: MYSQL_SERVICE_PASSWORD
              value: "st11338"
            - name: MYSQL_SERVICE_JDBC_PARAM
              value: "characterEncoding=utf8&connectTimeout=3000&socketTimeout=10000&autoReconnect=true&useSSL=false&allowPublicKeyRetrieval=true"

            # ========================================
            # 【修复点】Nacos 2.2.0 鉴权密钥 (Base64 编码)
            # ========================================
            - name: NACOS_AUTH_IDENTITY_KEY
              value: "nacos_server"
            - name: NACOS_AUTH_IDENTITY_VALUE
              value: "nacos_server"
            - name: NACOS_AUTH_TOKEN
              # 必须使用 Base64 编码，且原始长度 >= 32 字符
              # 原始字符串: SecretKey01234567890123456789012345678901
              value: "U2VjcmV0S2V5MDEyMzQ1Njc4OTAxMjM0NTY3ODkwMTIzNDU2Nzg5MDE="

            # ========================================
            # JVM 内存参数
            # ========================================
            - name: JVM_XMS
              value: "2g"
            - name: JVM_XMX
              value: "2g"
            - name: JVM_XMN
              value: "1g"
            - name: JVM_MS
              value: "128m"
            - name: JVM_MMS
              value: "320m"

          # ========================================
          # 3. 健康检查探针
          # ========================================
          startupProbe:
            httpGet:
              path: /nacos/index.html
              port: 8848
            initialDelaySeconds: 30
            periodSeconds: 10
            failureThreshold: 30

          livenessProbe:
            httpGet:
              path: /nacos/index.html
              port: 8848
            initialDelaySeconds: 60
            periodSeconds: 30

          readinessProbe:
            httpGet:
              path: /nacos/index.html
              port: 8848
            initialDelaySeconds: 40
            periodSeconds: 10

          # ========================================
          # 4. 资源限制
          # ========================================
          resources:
            requests:
              cpu: "500m"
              memory: "2Gi"
            limits:
              cpu: "2000m"
              memory: "4Gi"