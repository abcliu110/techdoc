<div id="chap-lombok"></div>

[⬆️ 返回目录](#catalog)


## lombok

Lombok 的实现原理可以概括为一句话：**在编译阶段，通过 Java 提供的注解处理器（Annotation Processor）插件机制，动态修改抽象语法树（AST），插入生成的代码。**

它不是通过反射实现的，也不是在运行期起作用，而是**字节码生成**技术的一种应用。

以下是详细的底层原理分析：

---

### 1. 核心依赖：JSR 269
Java 6 引入了 **JSR 269: Pluggable Annotation Processing API**（可插入式注解处理器）。这是 Lombok 赖以生存的基础。

*   **标准注解处理器**：通常用于扫描注解并生成**新的**源文件（例如 MapStruct、Dagger 或 Hibernate Metamodel）。
*   **Lombok 的特殊之处**：标准 API 只允许生成新文件，不允许修改已有的类。Lombok 通过“黑科技”（利用编译器内部 API）打破了这一限制，直接修改了当前正在编译的类的语法树。

---

### 2. 编译过程的生命周期
Java 源码编译成字节码的过程通常分为三个阶段，Lombok 介入了其中的第二步：

1.  **解析与填充符号表（Parse and Enter）**：
    *   编译器将 `.java` 源码解析成 **抽象语法树（AST）**。
2.  **注解处理（Annotation Processing）**：
    *   Lombok 的注解处理器被触发。它会遍历 AST，找到被 `@Data`、`@Getter` 等注解标记的节点，并根据注解含义，**手动往 AST 中注入新的节点**（例如方法声明、方法体、变量定义）。
3.  **分析与字节码生成（Analyze and Generate）**：
    *   编译器根据被 Lombok **修改后**的 AST 生成 `.class` 字节码文件。

**结果**：最终生成的 `.class` 文件中包含了完整的 getter/setter 方法，就好像是你亲手写的一样。

---

### 3. 关键组件：AST 与内部 API
Lombok 的底层实现深度耦合了编译器的内部实现：

*   **对于 Javac (OpenJDK/Oracle JDK)**：Lombok 使用了编译器内部的 `com.sun.tools.javac` 包。它将 AST 强转为 `JCTree` 对象，通过操作 `TreeMaker`（用于创建语法树节点）和 `Names`（用于处理标识符）来修改代码结构。
*   **对于 Eclipse (JDT)**：Eclipse 有自己的编译器，Lombok 同样针对 Eclipse 的内部 AST 结构编写了适配代码。

这就是为什么 Lombok 必须针对不同的 JDK 版本进行更新，因为编译器内部的私有 API 可能会发生变化。

---

### 4. 为什么 IDE（IntelliJ IDEA）需要安装插件？
这是初学者最常见的问题。既然 Lombok 在编译期工作，为什么 IDE 还要装插件？

*   **矛盾点**：IDE（如 IntelliJ）为了提供代码提示、语法检查，它会实时解析你的源码。但在 IDE 看来，你的代码里并没有 `getXXX()` 方法。
*   **插件的作用**：Lombok 插件的作用是**“欺骗” IDE**。它告诉 IDE 的编辑器：虽然源码里没写这个方法，但你可以认为它存在。这样你在敲代码时才会有自动补全，且不会报红。

---

### 5. Lombok 的优缺点分析

#### 优点：
1.  **消除样板代码**：极大地提高了代码的可读性和整洁度。
2.  **维护方便**：修改字段名时，不需要手动修改 getter/setter/toString。
3.  **零运行时开销**：代码在编译时就已经生成好了，运行速度和手写代码完全一致。

#### 缺点/风险：
1.  **强依赖插件**：团队所有成员都必须安装 IDE 插件。
2.  **调试困难**：由于源码中不存在方法，设置断点或查看源码跳转时可能会有困惑。
3.  **兼容性风险**：由于使用了编译器内部 API，升级 JDK 版本时可能导致 Lombok 失效。
4.  **“污染” AST**：它修改了标准的编译流程，有些架构师认为这是一种“侵入性过强”的 Hack 行为。

### 总结
Lombok 是一个**编译时代理**。它利用 **JSR 269** 接口，在编译器将源码转为语法树后，通过**暴力操作内部 API** 的方式修改了这棵树，把我们懒得写的代码“塞”了进去。

<!-- 跳转链接 -->
[⬆️ 返回目录](#catalog)  |  [文章开头 ➡️](#chap-lombok)