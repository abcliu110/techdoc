<div id="chap-install"></div>

[⬆️ 返回目录](#catalog)

## rancher安装系统

这份指南总结了在 **Ubuntu 24.04 LTS** 上为安装 **Rancher/Kubernetes** 进行自定义分区及 LVM 配置的全过程。

### 核心设计思路

- **不创建 Swap**：Kubernetes 调度器要求关闭 Swap 以保证性能稳定性。
- **EFI + LVM 架构**：EFI 负责引导，LVM 负责根目录 `/`。使用 LVM 的目的是为了将来磁盘空间不足时，可以实现“在线无痛扩容”。

---

### 第一阶段：安装程序中的分区步骤 (Custom Storage Layout)

在安装界面的 **"Storage Configuration"** 步骤，选择 **[X] Custom storage layout**，然后进入以下手动配置流程：

#### 1. 创建 EFI 引导分区 (引导必需)

- 在 **AVAILABLE DEVICES** 下找到你的硬盘，按回车选择 **Add GPT Partition**。
- **Size**: `1G` (建议 1GB，防止未来内核更新过多填满分区)。
- **Format**: `fat32`。
- **Mount**: `/boot/efi`。
- 点击 **Create**。

#### 2. 创建 LVM 物理容器 (地皮)

- 再次选择硬盘剩余的 **Free Space**，选择 **Add GPT Partition**。
- **Size**: 留空（默认使用剩余所有空间）。
- **Format**: **必须选择 `Leave unformatted`** (不格式化)。
- **Mount**: **保持为空 (None)**，不要选任何挂载点。
- 点击 **Create**。此时你会看到一个“未格式化”的分区。

#### 3. 创建卷组 Volume Group (大柜子)

- 在界面最下方或选中刚才创建的未格式化分区，选择 **Create LVM volume group**。
- **Name**: 保持默认 `ubuntu-vg` 即可。
- **Devices**: 确保勾选了刚才那个大的未格式化分区。
- 点击 **Create**。

#### 4. 创建逻辑卷 Logical Volume (抽屉)

- 在 **LVM volumes** 区域下，选中你刚创建的 `VG ubuntu-vg`，选择 **Create Logical Volume**。
- **Name**: 建议起名为 `ubuntu-lv` 或 `root`。
- **Size**: **保持为空**（代表占用该卷组的 100% 空间）。
- **Format**: `ext4`。
- **Mount**: **选择 `/`**。
- 点击 **Create**。

#### 5. 最终检查

你的界面应该显示：

1.  **Partition 1**: Type 为 `esp`，挂载在 `/boot/efi`。
2.  **Partition 2**: Type 为 `lvm`。
3.  **LVM volume**: 挂载在 `/`，没有 Swap 分区。

- 确认无误后点击 **Done**，在弹出警告时选择 **Continue**。

---

### 第二阶段：安装后的关键操作

#### 1. 彻底激活全部 LVM 空间

Ubuntu 默认有时只分配逻辑卷的一部分。进入系统后，请务必执行以下命令，确保根目录使用了全部硬盘：

```bash
# 1. 扩展逻辑卷到 100% 剩余空间
sudo lvextend -l +100%FREE /dev/ubuntu-vg/ubuntu-lv

# 2. 刷新文件系统（在线扩容，无需停机）
sudo resize2fs /dev/ubuntu-vg/ubuntu-lv
```

#### 2. 验证分区与 Swap 状态

```bash
# 查看分区大小和挂载点
df -h /

# 确认 Swap 确实为 0
free -h
```

---

### 第三阶段：为什么这么做？(Rancher 场景分析)

1.  **为什么不要 Swap？**
    K8s 监控节点资源时，如果内存不足会触发 Pod 驱逐。如果有 Swap，系统会变慢但不会立即触发保护，导致整个集群响应极其缓慢（雪崩效应）。
2.  **为什么不分 `/var` 或 `/home`？**
    Rancher 的镜像、日志、容器数据全部存在 `/var/lib/` 下。如果你单独给 `/var` 分了 20G，结果镜像下载了 30G，系统就会报错。**合为一个根分区 `/`** 是目前容器化部署的主流推荐做法，空间利用率最高。

3.  **LVM 的优势是什么？**
    如果你的 Rancher 运行半年后发现 100G 硬盘满了：
    - **非 LVM**：你可能需要备份、重装、分区，非常痛苦。
    - **LVM**：再买一块硬盘插上，运行 `vgextend` 和 `lvextend` 命令，**30 秒内就能在不关机的情况下把根目录从 100G 变成 200G**。

---

### 总结配置清单

- **EFI**: 1GB, FAT32, `/boot/efi`
- **Root (LVM)**: 剩余全部, EXT4, `/`
- **Swap**: **无 (None)**
- **AppArmor**: 需关闭 (`apparmor=0`)
- **Kernel Modules**: 需加载 `br_netfilter` 和 `overlay`

完成这些配置后，你的 Ubuntu 24.04 将是一个非常标准且稳健的 Rancher 宿主机节点。

<!-- 跳转链接 -->

[⬆️ 返回目录](#catalog) | [文章开头 ➡️](#chap-install)
