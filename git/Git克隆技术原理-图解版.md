# Git 克隆技术原理 - 图解版

## 一、branches: [[name: "*/${GIT_BRANCH}"]]

### 分支匹配原理

```
Git 仓库结构：
┌─────────────────────────────────┐
│ 远程仓库（GitHub/GitLab）        │
│                                 │
│ origin/master    ←─┐            │
│ origin/develop   ←─┤ 远程分支   │
│ origin/feature-x ←─┘            │
└─────────────────────────────────┘
         ↓ git clone
┌─────────────────────────────────┐
│ 本地仓库                         │
│                                 │
│ master (本地分支)                │
│   ↓                             │
│ origin/master (远程跟踪分支)     │
└─────────────────────────────────┘
```

### `*/master` 的匹配过程

```
步骤 1：获取所有远程分支
git fetch origin
  ↓
远程分支列表：
- origin/master
- origin/develop
- origin/feature-x

步骤 2：匹配模式 "*/master"
*/master 匹配：
✓ origin/master    ← 匹配成功
✗ origin/develop
✗ origin/feature-x

步骤 3：检出匹配的分支
git checkout -b master origin/master
```

---

## 二、depth: 1, shallow: true（浅克隆）

### 完整克隆 vs 浅克隆

```
完整克隆（git clone）：
┌─────────────────────────────────┐
│ 服务器                           │
│                                 │
│ commit 5 (最新) ─┐              │
│ commit 4        │              │
│ commit 3        ├─ 所有历史     │
│ commit 2        │              │
│ commit 1 (最早) ─┘              │
│                                 │
│ 大小：500 MB                    │
│ 时间：5 分钟                    │
└─────────────────────────────────┘
         ↓ 下载所有
┌─────────────────────────────────┐
│ 客户端                           │
│                                 │
│ commit 5 ✓                      │
│ commit 4 ✓                      │
│ commit 3 ✓                      │
│ commit 2 ✓                      │
│ commit 1 ✓                      │
│                                 │
│ 大小：500 MB                    │
└─────────────────────────────────┘

浅克隆（git clone --depth 1）：
┌─────────────────────────────────┐
│ 服务器                           │
│                                 │
│ commit 5 (最新) ─┐              │
│ commit 4        │              │
│ commit 3        ├─ 只发送最新   │
│ commit 2        │              │
│ commit 1 (最早) ─┘              │
│                                 │
│ 传输：50 MB                     │
│ 时间：30 秒                     │
└─────────────────────────────────┘
         ↓ 只下载最新
┌─────────────────────────────────┐
│ 客户端                           │
│                                 │
│ commit 5 ✓                      │
│ commit 4 ✗                      │
│ commit 3 ✗                      │
│ commit 2 ✗                      │
│ commit 1 ✗                      │
│                                 │
│ 大小：50 MB                     │
│ .git/shallow (标记文件)         │
└─────────────────────────────────┘
```

### Git 对象存储

```
完整克隆的 .git 目录：
.git/
├── objects/
│   ├── ab/c123... (commit 5)
│   ├── de/f456... (commit 4)
│   ├── 12/3abc... (commit 3)
│   ├── 45/6def... (commit 2)
│   ├── 78/9ghi... (commit 1)
│   ├── tree 对象（文件树）
│   └── blob 对象（文件内容）
└── refs/
    └── heads/master

大小：500 MB

浅克隆的 .git 目录：
.git/
├── objects/
│   ├── ab/c123... (commit 5) ← 只有最新
│   ├── tree 对象（当前文件树）
│   └── blob 对象（当前文件内容）
├── shallow          ← 浅克隆标记
│   └── abc123...    (最早的 commit SHA)
└── refs/
    └── heads/master

大小：50 MB
```

### 数据传输对比

```
完整克隆：
客户端                    服务器
  │                        │
  ├─ git clone ────────────>│
  │                        │
  │<──── 打包所有对象 ──────┤
  │      (500 MB)          │
  │                        │
  ├─ 解包 ─────────────────>│
  │                        │
  ✓ 完成（5 分钟）          │

浅克隆：
客户端                    服务器
  │                        │
  ├─ git clone --depth 1 ─>│
  │                        │
  │<──── 只打包最新对象 ────┤
  │      (50 MB)           │
  │                        │
  ├─ 解包 + 创建 shallow ──>│
  │                        │
  ✓ 完成（30 秒）           │
```

---

## 三、timeout: 20（超时控制）

### 超时机制

```
时间线：
10:00 ─┬─ 开始 git clone
       │
10:05 ─┤  下载中... (25%)
       │
10:10 ─┤  下载中... (50%)
       │
10:15 ─┤  下载中... (75%)
       │
10:20 ─┴─ 超时！强制终止 ✗

       ↑
    20 分钟
```

### Jenkins 超时处理流程

```
┌─────────────────────────────────┐
│ Jenkins 主进程                   │
│                                 │
│ 启动 Git 克隆                    │
│   ↓                             │
│ ┌─────────────────────────────┐ │
│ │ Git 子进程 (PID: 12345)     │ │
│ │                             │ │
│ │ git clone https://...       │ │
│ │                             │ │
│ │ 下载中...                   │ │
│ └─────────────────────────────┘ │
│   ↓                             │
│ 等待最多 20 分钟                 │
│   ↓                             │
│ 超时检查：                       │
│   if (时间 > 20 分钟) {         │
│       kill -9 12345             │
│       throw TimeoutException    │
│   }                             │
└─────────────────────────────────┘
```

### 不同网络速度的影响

```
快速网络（100 Mbps）：
0:00 ─┬─ 开始
      │
0:30 ─┴─ 完成 ✓

timeout: 20 分钟（足够）

慢速网络（1 Mbps）：
0:00 ─┬─ 开始
      │
5:00 ─┤  25%
      │
10:00 ┤  50%
      │
15:00 ┤  75%
      │
20:00 ┴─ 超时 ✗

timeout: 20 分钟（不够）
建议：timeout: 60
```

---

## 四、完整的 Git 克隆流程

### Jenkins 执行的完整流程

```
┌─────────────────────────────────────────────┐
│ 1. 准备阶段                                  │
│    - 清理工作空间 (deleteDir)                │
│    - 创建目标目录                            │
└─────────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────┐
│ 2. 初始化 Git                                │
│    git init                                  │
│    git remote add origin https://...        │
└─────────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────┐
│ 3. 获取远程分支（浅克隆）                     │
│    git fetch --depth 1 origin master        │
│                                             │
│    传输数据：50 MB                           │
│    时间：30 秒                               │
│    超时检查：每秒检查一次                     │
└─────────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────┐
│ 4. 检出分支                                  │
│    git checkout -b master origin/master     │
│                                             │
│    创建本地分支：master                      │
│    跟踪远程分支：origin/master               │
└─────────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────┐
│ 5. 完成                                      │
│    - 代码已检出                              │
│    - 可以开始构建                            │
└─────────────────────────────────────────────┘
```

### 等价的 Git 命令

```bash
# Jenkins 实际执行的命令序列

# 1. 初始化
git init
git remote add origin https://github.com/user/repo.git

# 2. 浅克隆（depth=1）
git fetch --depth 1 origin master

# 3. 检出分支
git checkout -b master origin/master

# 4. 验证
git log -1  # 只能看到最新一次提交
git branch  # 只有 master 分支
```

---

## 五、性能对比总结

### 数据对比表

| 项目 | 完整克隆 | 浅克隆 (depth=1) | 节省 |
|------|---------|-----------------|------|
| 下载大小 | 500 MB | 50 MB | 90% |
| 下载时间 | 5 分钟 | 30 秒 | 90% |
| 磁盘占用 | 500 MB | 50 MB | 90% |
| 历史记录 | 全部 | 最新 1 次 | - |
| 可切换分支 | 是 | 否 | - |
| 适用场景 | 开发 | CI/CD | - |

### 为什么 CI/CD 使用浅克隆？

```
CI/CD 的需求：
┌─────────────────────────────────┐
│ ✓ 只需要最新代码                 │
│ ✓ 不需要查看历史                 │
│ ✓ 不需要切换分支                 │
│ ✓ 速度要快                       │
│ ✓ 占用空间小                     │
│ ✓ 每次构建都是全新环境            │
└─────────────────────────────────┘
         ↓
    浅克隆完美匹配
```

---

## 六、故障排查

### 常见问题

**问题 1：超时**
```
错误：Timeout after 20 minutes
原因：网络慢或仓库太大
解决：增加 timeout: 60
```

**问题 2：浅克隆限制**
```
错误：fatal: shallow file has changed
原因：尝试访问历史提交
解决：使用完整克隆或增加 depth
```

**问题 3：分支不存在**
```
错误：Couldn't find remote ref refs/heads/master
原因：分支名错误
解决：检查 GIT_BRANCH 变量
```

### 调试命令

```bash
# 查看浅克隆状态
cat .git/shallow

# 查看远程分支
git branch -r

# 查看克隆深度
git log --oneline | wc -l

# 转换为完整克隆
git fetch --unshallow
```
